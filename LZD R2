library(mrgsolve)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(ggsci)
library(flextable)
library(officer)
library(tidyr)
library(reshape2)

setwd("C:/Users/thomas.duflot/Desktop/LZD")
set.seed(123)

my_theme <- theme_minimal(base_size = 16) +
  theme(
    axis.title = element_text(size = 18, color = "black"),      # Axis labels size and color
    axis.text = element_text(size = 16, color = "black"),       # Axis ticks size and color
    axis.line = element_line(linewidth = 1.5),                  # Axis lines size
    legend.title = element_text(size = 18, color = "black"),    # Legend title size and color
    legend.text = element_text(size = 16, color = "black")      # Legend text size and color
  )


# Define the PK model
Luque <- '
$PROB
$PARAM @annotated
TVCL : 16.6  : 1  Clearance (L.h-1)
TVVC : 43.2  : 2  Central volume (L)
TVVP : 58 : 3 Peripheral volume (L)
TVQ : 3.1 : Intercompartimental clearance peripheral (L.h-1)
TVVCSF : 0.11 : CSF Volume (L)
TVQCSF : 0.05 : Intercompartimental clearance CSF (L.h-1)



$OMEGA @block
0.225 // CL
0 0.0231 // VC
0 0 0.0067 // VP
0 0 0 0.582 // Q
0 0 0 0 0 // VCSF
0 0 0 0 0 0 // QCSF


$SIGMA 
0 // err prop
0 //  err additive


$CMT @annotated
CENTRAL : Central compartment (mg/L) [ADM] [OBS]
CSF : CSF compartment (mg/L) [OBS]
PERIPHERAL : Peripheral compartment (mg/L)
AUCP : AUC in Plasma (mg/L.h)
AUCCSF : AUC in CSF (mg/L.h)


$TABLE
double DV  = (CENTRAL / VC) ;
double DVCSF = (CSF / VCSF);
double DVf = DV;


$MAIN
double CL = TVCL *exp(ETA(1))   ;
double VC = TVVC *exp(ETA(2))  ;
double VP = TVVP *exp(ETA(3))   ;
double Q = TVQ * exp(ETA(4)) ;
double VCSF = TVVCSF * exp(ETA(5)) ;
double QCSF = TVQCSF * exp(ETA(6)) ;
double K10 = CL/VC;
double K12 = Q/VC;
double K21 = Q/VP;
double K13 = QCSF/VC;
double K31 = QCSF/VCSF;


$ODE

dxdt_CENTRAL      = -K10* CENTRAL - K12*CENTRAL - K13 * CENTRAL + K21*PERIPHERAL + K31 * CSF ;
dxdt_CSF    = K13*CENTRAL - K31 * CSF ;
dxdt_PERIPHERAL = K12*CENTRAL - K21*PERIPHERAL ;
dxdt_AUCP = DVf;
dxdt_AUCCSF = DVCSF;

$CAPTURE DV DVf DVCSF '



# Define the Luque model
Luque_mod <- mrgsolve::mcode("Luque_optim", Luque, atol=1e-8, rtol=1e-8, maxsteps=5000)

# Define the dosing events with Luque_ prefix
Luque_events <- list(
  `600q12h` = ev(amt = 600, rate = 600, cmt = 1, ii = 12, addl = 20),
  `600q8h` = ev(amt = 600, rate = 600, cmt = 1, ii = 8, addl = 20),
  `600q6h` = ev(amt = 600, rate = 600, cmt = 1, ii = 6, addl = 20),
  `1200q24hCI` = ev(amt = 4800, rate = 50, cmt = 1, ii = 0, addl = 0),
  `1800q24hCI` = ev(amt = 7200, rate = 75, cmt = 1, ii = 0, addl = 0),
  `2400q24hCI` = ev(amt = 9600, rate = 100, cmt = 1, ii = 0, addl = 0)
)

n_individuals <- 1000
Luque_model_name <- "Luque"  # Add the model name here
MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)  # Define the MIC thresholds

Luque_PTA_results <- list()  # Store PTA results with Luque_ prefix

# Function to calculate % of patients with fT > MIC for at least 85% of the time
calc_pta_for_MIC <- function(data, MIC) {
  # Group by ID and check if >= 85% of the time is above the MIC
  Luque_pta_DVf <- data %>%
    group_by(ID) %>%
    summarize(fT_above_MIC = mean(DVf >= MIC)) %>%
    summarize(Luque_PTA_DVf = mean(fT_above_MIC >= 0.85) * 100)  # % of patients with fT > MIC for >= 85% of the time
  
  Luque_pta_DVCSF <- data %>%
    group_by(ID) %>%
    summarize(fT_above_MIC = mean(DVCSF >= MIC)) %>%
    summarize(Luque_PTA_DVCSF = mean(fT_above_MIC >= 0.85) * 100)  # % of patients with fT > MIC for >= 85% of the time
  
  return(c(Luque_PTA_DVf = Luque_pta_DVf$Luque_PTA_DVf, Luque_PTA_DVCSF = Luque_pta_DVCSF$Luque_PTA_DVCSF))
}

for (Luque_event_name in names(Luque_events)) {
  Luque_ev_current <- Luque_events[[Luque_event_name]]
  
  # Run the simulation for the current event
  Luque_out <- Luque_mod %>%
    ev(Luque_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Extract data for time points between 72 and 96 hours
  Luque_out_72_96 <- Luque_out %>%
    as.data.frame() %>%
    filter(time >= 72 & time <= 96)
  
  # Calculate PTA for each MIC value
  Luque_PTA_fractions <- sapply(MIC_values, function(MIC) {
    calc_pta_for_MIC(Luque_out_72_96, MIC)
  })
  
  # Convert to data frame and store results
  Luque_PTA_fractions_df <- as.data.frame(t(Luque_PTA_fractions))
  colnames(Luque_PTA_fractions_df) <- c("Luque_PTA_DVf", "Luque_PTA_DVCSF")
  Luque_PTA_fractions_df$MIC <- MIC_values
  Luque_PTA_fractions_df$Luque_Dosing <- Luque_event_name  # Add dosing regimen
  Luque_PTA_fractions_df$Model <- "Luque"  # Add Model column
  
  # Rename columns to remove Luque_ prefix
  Luque_PTA_fractions_df <- Luque_PTA_fractions_df %>%
    rename(
      PTA_DVf = Luque_PTA_DVf,
      PTA_DVCSF = Luque_PTA_DVCSF,
      Dosing = Luque_Dosing,
      Model = Model  # Keep the Model column
    )

  # Store the PTA results for each event
  Luque_PTA_results[[Luque_event_name]] <- Luque_PTA_fractions_df
}

# Combine all PTA results into one data frame
Luque_PTA_combined_results <- bind_rows(Luque_PTA_results)



# Define the PK model
Li <- '
$PROB
$PARAM @annotated
TVCL : 6.86  : 1  Clearance (L.h-1)
TVVC : 52  : 2  Central volume (L)
TVVCSF : 0.11 : CSF Volume (L)
TVQCSF : 0.02 : Intercompartimental clearance CSF (L.h-1)
TVPC : 0.72 : Transfer Multiplier
TVCLCSF : 0.008333 : CSF Drainage Volume (L.h-1)

$PARAM @annotated @covariates

CrCl : 98.53 : Creatinine clearance (mL/min/1.73m²)
CrCl_CL : 0.87 : Effect of Creatinine Clearance on CL
PCT : 0.14 : PCT
PCT_Q : 0.25 : Effect of PCT on PC

$OMEGA @block
0.202 // CL
0 0 // VC
0 0 0 // VCSF
0 0 0 0 // QCSF
0 0 0 0 0.0422 // PC
0 0 0 0 0 0.024 // CLCSF
0 0 0 0 0 0 0 // CrCl_CL
0 0 0 0 0 0 0 0 // PCT_Q


$SIGMA 
0 // err prop
0 //  err additive


$CMT @annotated
CENTRAL : Central compartment (mg/L) [ADM] [OBS]
CSF : CSF compartment (mg/L) [OBS]
AUCP : AUC in Plasma (mg/L.h)
AUCCSF : AUC in CSF (mg/L.h)


$TABLE
double DV  = (CENTRAL / VC) ;
double DVCSF = (CSF / VCSF);
double DVf = DV;

$MAIN
double CL = TVCL *exp(ETA(1))* pow((CrCl/98.53),(CrCl_CL*exp(ETA(7))))   ;
double VC = TVVC *exp(ETA(2))  ;
double VCSF = TVVCSF * exp(ETA(3)) ;
double QCSF = TVQCSF *exp(ETA(4))* pow((PCT/0.14),(PCT_Q*exp(ETA(8)))) ;
double PC = TVPC*exp(ETA(5));
double CLCSF = TVCLCSF * exp(ETA(6)) ;
double K10 = CL/VC;
double K12 = QCSF/VC;
double K21 = QCSF/VCSF;
double KCSF = CLCSF/TVVCSF;



$ODE

dxdt_CENTRAL      = -K10* CENTRAL - (K12*PC)*CENTRAL + K21*CSF  ;
dxdt_CSF    = K12*CENTRAL - K21*CSF - KCSF*CSF ;
dxdt_AUCP = DVf;
dxdt_AUCCSF = DVCSF;

$CAPTURE DV DVf DVCSF'


# Define the Li model
Li_mod <- mrgsolve::mcode("Li_optim", Li, atol=1e-8, rtol=1e-8, maxsteps=5000)

# Define the dosing events with Li_ prefix
Li_events <- list(
  `600q12h` = ev(amt = 600, rate = 600, cmt = 1, ii = 12, addl = 20),
  `600q8h` = ev(amt = 600, rate = 600, cmt = 1, ii = 8, addl = 20),
  `600q6h` = ev(amt = 600, rate = 600, cmt = 1, ii = 6, addl = 20),
  `1200q24hCI` = ev(amt = 4800, rate = 50, cmt = 1, ii = 0, addl = 0),
  `1800q24hCI` = ev(amt = 7200, rate = 75, cmt = 1, ii = 0, addl = 0),
  `2400q24hCI` = ev(amt = 9600, rate = 100, cmt = 1, ii = 0, addl = 0)
)

n_individuals <- 1000
Li_model_name <- "Li"  # Add the model name here
MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)  # Define the MIC thresholds

Li_PTA_results <- list()  # Store PTA results with Li_ prefix

for (Li_event_name in names(Li_events)) {
  Li_ev_current <- Li_events[[Li_event_name]]
  
  # Run the simulation for the current event
  Li_out <- Li_mod %>%
    ev(Li_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Extract data for time points between 72 and 96 hours
  Li_out_72_96 <- Li_out %>%
    as.data.frame() %>%
    filter(time >= 72 & time <= 96)
  
# Function to calculate % of patients with fT > MIC for at least 85% of the time
calc_pta_for_MIC <- function(data, MIC) {
  # Group by ID and check if >= 85% of the time is above the MIC
  Li_pta_DVf <- data %>%
    group_by(ID) %>%
    summarize(fT_above_MIC = mean(DVf >= MIC)) %>%
    summarize(Li_PTA_DVf = mean(fT_above_MIC >= 0.85) * 100)  # % of patients with fT > MIC for >= 85% of the time
  
  Li_pta_DVCSF <- data %>%
    group_by(ID) %>%
    summarize(fT_above_MIC = mean(DVCSF >= MIC)) %>%
    summarize(Li_PTA_DVCSF = mean(fT_above_MIC >= 0.85) * 100)  # % of patients with fT > MIC for >= 85% of the time
  
  return(c(Li_PTA_DVf = Li_pta_DVf$Li_PTA_DVf, Li_PTA_DVCSF = Li_pta_DVCSF$Li_PTA_DVCSF))
}
  # Calculate PTA for each MIC value
  Li_PTA_fractions <- sapply(MIC_values, function(MIC) {
    calc_pta_for_MIC(Li_out_72_96, MIC)
  })
  
  # Convert to data frame and store results
  Li_PTA_fractions_df <- as.data.frame(t(Li_PTA_fractions))
  colnames(Li_PTA_fractions_df) <- c("Li_PTA_DVf", "Li_PTA_DVCSF")
  Li_PTA_fractions_df$MIC <- MIC_values
  Li_PTA_fractions_df$Li_Dosing <- Li_event_name  # Add dosing regimen
  Li_PTA_fractions_df$Model <- "Li"  # Add Model column
  
  # Rename columns to remove Li_ prefix
  Li_PTA_fractions_df <- Li_PTA_fractions_df %>%
    rename(
      PTA_DVf = Li_PTA_DVf,
      PTA_DVCSF = Li_PTA_DVCSF,
      Dosing = Li_Dosing,
      Model = Model  # Remove prefix from the Model column
    )

  # Store the PTA results for each event
  Li_PTA_results[[Li_event_name]] <- Li_PTA_fractions_df
}

# Combine all PTA results into one data frame
Li_PTA_combined_results <- bind_rows(Li_PTA_results)





















# Define the PK model
DF <- '
$PROB
$PARAM @annotated
TVCL : 8.38  : 1  Clearance (L.h-1)
TVVC : 36.4  : 2  Central volume (L)
TVVCSF : 0.15 : CSF Volume (L)
TVQCSFin : 0.04 : Intercompartimental clearance CSF (L.h-1)
TVQCSFout : 0.0367 : Intercompartimental clearance CSF (L.h-1)
TVCLEVD : 0.0102 : Clearance EVD

$PARAM @annotated @covariates

WT : 70 : Creatinine clearance (mL/min/1.73m²)
WT_VC : 0.0115 : Coefficient of the linear relationship between V1pop and patient weight


$OMEGA @block
0.187 // CL
0 0.052 // VC
0 0 0 // VCSF
0 0 0 0.02225 // QCSFin
0 0 0 0 0 // QCSFout
0 0 0 0 0 0.209765 // CLEVD


$SIGMA 
0 // err prop
0 //  err additive


$CMT @annotated
CENTRAL : Central compartment (mg/L) [ADM] [OBS]
CSF : CSF compartment (mg/L) [OBS]
AUCP : AUC in Plasma (mg/L.h)
AUCCSF : AUC in CSF (mg/L.h)


$TABLE
double DV  = (CENTRAL / VC) ;
double DVCSF = (CSF / VCSF);
double DVf = DV;

$MAIN
double CL = TVCL *exp(ETA(1))   ;
double VC = TVVC *(1+0.0115*(WT-74)*exp(ETA(2)))  ;
double VCSF = TVVCSF * exp(ETA(3)) ;
double QCSFin = TVQCSFin *exp(ETA(4)) ;
double QCSFout = TVQCSFout * exp(ETA(5)) ;
double CLEVD = TVCLEVD*exp(ETA(6));
double K10 = CL/VC;
double K12 = QCSFin/VC;
double K21 = QCSFout/VCSF;
double K23 = CLEVD/VCSF;


$ODE

dxdt_CENTRAL      = -K10* CENTRAL - 0.69*K12*CENTRAL + K21*CSF  ;
dxdt_CSF    = 0.69*K12*CENTRAL - K21*CSF - K23*CSF ;
dxdt_AUCP = DVf;
dxdt_AUCCSF = DVCSF;

$CAPTURE DV DVf DVCSF'


# Define the DF model
DF_mod <- mrgsolve::mcode("DF_optim", DF, atol=1e-8, rtol=1e-8, maxsteps=5000)





# Define the dosing events with DF_ prefix
DF_events <- list(
  `600q12h` = ev(amt = 600, rate = 1200, cmt = 1, ii = 12, addl = 20),
  `600q8h` = ev(amt = 600, rate = 1200, cmt = 1, ii = 8, addl = 20),
  `600q6h` = ev(amt = 600, rate = 1200, cmt = 1, ii = 6, addl = 20),
  `1200q24hCI` = ev(amt = 4800, rate = 50, cmt = 1, ii = 0, addl = 0),
  `1800q24hCI` = ev(amt = 7200, rate = 75, cmt = 1, ii = 0, addl = 0),
  `2400q24hCI` = ev(amt = 9600, rate = 100, cmt = 1, ii = 0, addl = 0)
)

n_individuals <- 1000
DF_model_name <- "DF"  # Add the model name here
MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)  # Define the MIC thresholds

DF_PTA_results <- list()  # Store PTA results with DF_ prefix

for (DF_event_name in names(DF_events)) {
  DF_ev_current <- DF_events[[DF_event_name]]
  
  # Run the simulation for the current event
  DF_out <- DF_mod %>%
    ev(DF_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Extract data for time points between 72 and 96 hours
  DF_out_72_96 <- DF_out %>%
    as.data.frame() %>%
    filter(time >= 72 & time <= 96)
  
# Function to calculate % of patients with fT > MIC for at least 85% of the time
calc_pta_for_MIC <- function(data, MIC) {
  # Group by ID and check if >= 85% of the time is above the MIC
  DF_pta_DVf <- data %>%
    group_by(ID) %>%
    summarize(fT_above_MIC = mean(DVf >= MIC)) %>%
    summarize(DF_PTA_DVf = mean(fT_above_MIC >= 0.85) * 100)  # % of patients with fT > MIC for >= 85% of the time
  
  DF_pta_DVCSF <- data %>%
    group_by(ID) %>%
    summarize(fT_above_MIC = mean(DVCSF >= MIC)) %>%
    summarize(DF_PTA_DVCSF = mean(fT_above_MIC >= 0.85) * 100)  # % of patients with fT > MIC for >= 85% of the time
  
  return(c(DF_PTA_DVf = DF_pta_DVf$DF_PTA_DVf, DF_PTA_DVCSF = DF_pta_DVCSF$DF_PTA_DVCSF))
}
  # Calculate PTA for each MIC value
  DF_PTA_fractions <- sapply(MIC_values, function(MIC) {
    calc_pta_for_MIC(DF_out_72_96, MIC)
  })
  
  # Convert to data frame and store results
  DF_PTA_fractions_df <- as.data.frame(t(DF_PTA_fractions))
  colnames(DF_PTA_fractions_df) <- c("DF_PTA_DVf", "DF_PTA_DVCSF")
  DF_PTA_fractions_df$MIC <- MIC_values
  DF_PTA_fractions_df$DF_Dosing <- DF_event_name  # Add dosing regimen
  DF_PTA_fractions_df$Model <- "DF"  # Add Model column
  
  # Rename columns to remove DF_ prefix
  DF_PTA_fractions_df <- DF_PTA_fractions_df %>%
    rename(
      PTA_DVf = DF_PTA_DVf,
      PTA_DVCSF = DF_PTA_DVCSF,
      Dosing = DF_Dosing,
      Model = Model  # Remove prefix from the Model column
    )

  # Store the PTA results for each event
  DF_PTA_results[[DF_event_name]] <- DF_PTA_fractions_df
}

# Combine all PTA results into one data frame
DF_PTA_combined_results <- bind_rows(DF_PTA_results)



##### META MODEL #####
## ───────────────────────────────────────────────────────────────
## 1.  Les trois modèles publiés, inchangés
##     (copier-coller vos blocs Luque / Li / DF)
## ───────────────────────────────────────────────────────────────
library(mrgsolve)
library(dplyr)
library(ggplot2)
library(ggsci)

## blocs mrgsolve déjà compilés -----------------------------
mod_li    <- Li_mod      # <<– ceux que vous avez créés plus haut
mod_luque <- Luque_mod
mod_df    <- DF_mod

## ─────────────────────────────────────────────────────────────
## 0.  Poids (échantillons) et modèles déjà compilés -----------
## ─────────────────────────────────────────────────────────────
w      <- c(Li = 126, Luque = 46, DF = 87)   # ← nombres d’échantillons
models <- list(Li = mod_li, Luque = mod_luque, DF = mod_df)

## ─────────────────────────────────────────────────────────────
## 1.  Tirage des 1000 sujets  --------------------------------
## ─────────────────────────────────────────────────────────────
set.seed(123)
N  <- 1000
lab <- c("Li","Luque","DF",                          # ≥1 par modèle
         sample(names(w), N-3, replace = TRUE, prob = w))
lab <- sample(lab)                                   # mélange

## nombre de sujets par modèle
n_by_mod <- table(factor(lab, levels = names(models)))

## ─────────────────────────────────────────────────────────────
## 2.  Simulation (nid = n, pas de id / idata) ---------------
## ─────────────────────────────────────────────────────────────
dose <- ev(amt = 600, rate = 600, ii = 12, addl = 9)

shift <- 0L                 # pour décaler les ID et garder unicité
sim_list <- vector("list", length(models))
names(sim_list) <- names(models)

for(m in names(models)) {
  n_i <- as.integer(n_by_mod[m])
  out <- models[[m]] %>% ev(dose) %>% 
         mrgsim(nid = n_i, end = 150, delta = .25) %>% 
         as_tibble() %>% 
         mutate(ID = ID + shift,     # IDs uniques
                Group = m)
  shift <- shift + n_i               # prochain decalage
  sim_list[[m]] <- out
}

sim_all <- bind_rows(sim_list)

## ─────────────────────────────────────────────────────────────
## 3.  Résumés + méta-courbe  ---------------------------------
## ─────────────────────────────────────────────────────────────
sum_all <- sim_all %>% 
  group_by(time, Group) %>% 
  summarise(median  = median(DVf),
            lIQR    = quantile(DVf, .25),
            uIQR    = quantile(DVf, .75),
            l95     = quantile(DVf, .05),
            u95     = quantile(DVf, .95), .groups = "drop")

meta <- sum_all %>% 
  mutate(w = w[Group]) %>% 
  group_by(time) %>% 
  summarise(across(c(median,lIQR:u95), ~ weighted.mean(.x, w)),
            .groups = "drop") %>% 
  mutate(Group = "Meta")

plot_df <- bind_rows(sum_all, meta) %>% 
  mutate(Group = factor(Group, levels = c("Li","Luque","DF","Meta")))

## ─────────────────────────────────────────────────────────────
## 4.  Traçage  ------------------------------------------------
## ─────────────────────────────────────────────────────────────
cols <- setNames(pal_jco()(4), levels(plot_df$Group))

ggplot(plot_df, aes(time, median, colour = Group, fill = Group)) +
  geom_ribbon(aes(ymin = l95, ymax = u95), alpha = .15, linewidth = 0) +
  geom_ribbon(aes(ymin = lIQR, ymax = uIQR), alpha = .30, linewidth = 0) +
  geom_line(size = 1.2) +
  facet_wrap(~ Group, ncol = 2, scales = "free_y") +
  scale_colour_manual(values = cols) +
  scale_fill_manual(values   = cols) +
  theme_minimal(base_size = 14) +
  labs(x = "Time (h)", y = "Free linezolid (mg/L)",
       title = "Linezolid – 1000 simulated subjects\n(3 modèles structuraux + méta pondérée)")























combined_results_fT <- bind_rows(Luque_PTA_combined_results, Li_PTA_combined_results,DF_PTA_combined_results)
combined_results_fT$Model <- factor(combined_results_fT$Model, levels = c("Li","Luque","DF"))









n_individuals <- 1000
Luque_model_name <- "Luque"  # Add the model name here
MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)  # Define the MIC thresholds

Luque_AUC_PTA_results <- list()  # Store PTA results for AUC/MIC > 100

for (Luque_event_name in names(Luque_events)) {
  Luque_ev_current <- Luque_events[[Luque_event_name]]
  
  # Run the simulation for the current event
  Luque_out <- Luque_mod %>%
    ev(Luque_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Extract data for time points between 72 and 96 hours
  Luque_out_72_96 <- Luque_out %>%
    as.data.frame() %>%
    filter(time >= 72 & time <= 96)
  
  # Summarize the AUC for AUCP and AUCCSF between 72 and 96 hours
  Luque_AUC_summary <- Luque_out_72_96 %>%
    group_by(ID) %>%
    summarize(
      AUCP_72_96 = max(AUCP) - min(AUCP),           # Calculate AUC for plasma as difference between max and min
      AUCCSF_72_96 = max(AUCCSF) - min(AUCCSF)      # Calculate AUC for CSF as difference between max and min
    ) %>%
    mutate(Dosing = factor(Luque_event_name),          # Add a column for event as a factor
           Model = factor(Luque_model_name))           # Add a column for model as a factor
  
  # Function to calculate PTA for AUC/MIC > 100
  calc_pta_for_AUC_MIC <- function(data, MIC) {
    # Calculate the AUC/MIC ratio and determine if it is greater than 10
    Luque_pta_AUCP <- data %>%
      mutate(AUC_MIC_P = AUCP_72_96*0.69 / MIC) %>% 
      summarize(PTA_AUCP = mean(AUC_MIC_P > 100) * 100)  # % of patients with AUC/MIC > 100
    
    Luque_pta_AUCCSF <- data %>%
      mutate(AUC_MIC_CSF = AUCCSF_72_96 / MIC) %>%
      summarize(PTA_AUCCSF = mean(AUC_MIC_CSF > 100) * 100)  # % of patients with AUC/MIC > 100
    
    return(c(PTA_AUCP = Luque_pta_AUCP$PTA_AUCP, PTA_AUCCSF = Luque_pta_AUCCSF$PTA_AUCCSF))
  }
  
  # Calculate PTA for each MIC value
  Luque_PTA_AUC <- sapply(MIC_values, function(MIC) {
    calc_pta_for_AUC_MIC(Luque_AUC_summary, MIC)
  })
  
  # Convert to data frame and store results
  Luque_PTA_AUC_df <- as.data.frame(t(Luque_PTA_AUC))
  colnames(Luque_PTA_AUC_df) <- c("PTA_AUCP", "PTA_AUCCSF")
  Luque_PTA_AUC_df$MIC <- MIC_values
  Luque_PTA_AUC_df$Dosing <- Luque_event_name  # Add dosing regimen
  Luque_PTA_AUC_df$Model <- "Luque"  # Add Model column
  
  # Store the PTA results for each event
  Luque_AUC_PTA_results[[Luque_event_name]] <- Luque_PTA_AUC_df
}

# Combine all PTA results into one data frame
Luque_AUC_combined_results <- bind_rows(Luque_AUC_PTA_results)







n_individuals <- 1000
Li_model_name <- "Li"  # Add the model name here
MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)  # Define the MIC thresholds

Li_AUC_PTA_results <- list()  # Store PTA results for AUC/MIC > 100

for (Li_event_name in names(Li_events)) {
  Li_ev_current <- Li_events[[Li_event_name]]
  
  # Run the simulation for the current event
  Li_out <- Li_mod %>%
    ev(Li_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Extract data for time points between 72 and 96 hours
  Li_out_72_96 <- Li_out %>%
    as.data.frame() %>%
    filter(time >= 72 & time <= 96)
  
  # Summarize the AUC for AUCP and AUCCSF between 72 and 96 hours
  Li_AUC_summary <- Li_out_72_96 %>%
    group_by(ID) %>%
    summarize(
      AUCP_72_96 = max(AUCP) - min(AUCP),           # Calculate AUC for plasma as difference between max and min
      AUCCSF_72_96 = max(AUCCSF) - min(AUCCSF)      # Calculate AUC for CSF as difference between max and min
    ) %>%
    mutate(Dosing = factor(Li_event_name),          # Add a column for event as a factor
           Model = factor(Li_model_name))           # Add a column for model as a factor
  
  # Function to calculate PTA for AUC/MIC > 100
  calc_pta_for_AUC_MIC <- function(data, MIC) {
    # Calculate the AUC/MIC ratio and determine if it is greater than 10
    Li_pta_AUCP <- data %>%
      mutate(AUC_MIC_P = AUCP_72_96*0.69 / MIC) %>% 
      summarize(PTA_AUCP = mean(AUC_MIC_P > 100) * 100)  # % of patients with AUC/MIC > 100
    
    Li_pta_AUCCSF <- data %>%
      mutate(AUC_MIC_CSF = AUCCSF_72_96 / MIC) %>%
      summarize(PTA_AUCCSF = mean(AUC_MIC_CSF > 100) * 100)  # % of patients with AUC/MIC > 100
    
    return(c(PTA_AUCP = Li_pta_AUCP$PTA_AUCP, PTA_AUCCSF = Li_pta_AUCCSF$PTA_AUCCSF))
  }
  
  # Calculate PTA for each MIC value
  Li_PTA_AUC <- sapply(MIC_values, function(MIC) {
    calc_pta_for_AUC_MIC(Li_AUC_summary, MIC)
  })
  
  # Convert to data frame and store results
  Li_PTA_AUC_df <- as.data.frame(t(Li_PTA_AUC))
  colnames(Li_PTA_AUC_df) <- c("PTA_AUCP", "PTA_AUCCSF")
  Li_PTA_AUC_df$MIC <- MIC_values
  Li_PTA_AUC_df$Dosing <- Li_event_name  # Add dosing regimen
  Li_PTA_AUC_df$Model <- "Li"  # Add Model column
  
  # Store the PTA results for each event
  Li_AUC_PTA_results[[Li_event_name]] <- Li_PTA_AUC_df
}

# Combine all PTA results into one data frame
Li_AUC_combined_results <- bind_rows(Li_AUC_PTA_results)






n_individuals <- 1000
DF_model_name <- "DF"  # Add the model name here
MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)  # Define the MIC thresholds

DF_AUC_PTA_results <- list()  # Store PTA results for AUC/MIC > 10

for (DF_event_name in names(DF_events)) {
  DF_ev_current <- DF_events[[DF_event_name]]
  
  # Run the simulation for the current event
  DF_out <- DF_mod %>%
    ev(DF_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Extract data for time points between 72 and 96 hours
  DF_out_72_96 <- DF_out %>%
    as.data.frame() %>%
    filter(time >= 72 & time <= 96)
  
  # Summarize the AUC for AUCP and AUCCSF between 72 and 96 hours
  DF_AUC_summary <- DF_out_72_96 %>%
    group_by(ID) %>%
    summarize(
      AUCP_72_96 = max(AUCP) - min(AUCP),           # Calculate AUC for plasma as difference between max and min
      AUCCSF_72_96 = max(AUCCSF) - min(AUCCSF)      # Calculate AUC for CSF as difference between max and min
    ) %>%
    mutate(Dosing = factor(DF_event_name),          # Add a column for event as a factor
           Model = factor(DF_model_name))           # Add a column for model as a factor
  
  # Function to calculate PTA for AUC/MIC > 100
  calc_pta_for_AUC_MIC <- function(data, MIC) {
    # Calculate the AUC/MIC ratio and determine if it is greater than 10
    DF_pta_AUCP <- data %>%
      mutate(AUC_MIC_P = AUCP_72_96*0.69 / MIC) %>% 
      summarize(PTA_AUCP = mean(AUC_MIC_P > 100) * 100)  # % of patients with AUC/MIC > 10
    
    DF_pta_AUCCSF <- data %>%
      mutate(AUC_MIC_CSF = AUCCSF_72_96 / MIC) %>%
      summarize(PTA_AUCCSF = mean(AUC_MIC_CSF > 100) * 100)  # % of patients with AUC/MIC > 10
    
    return(c(PTA_AUCP = DF_pta_AUCP$PTA_AUCP, PTA_AUCCSF = DF_pta_AUCCSF$PTA_AUCCSF))
  }
  
  # Calculate PTA for each MIC value
  DF_PTA_AUC <- sapply(MIC_values, function(MIC) {
    calc_pta_for_AUC_MIC(DF_AUC_summary, MIC)
  })
  
  # Convert to data frame and store results
  DF_PTA_AUC_df <- as.data.frame(t(DF_PTA_AUC))
  colnames(DF_PTA_AUC_df) <- c("PTA_AUCP", "PTA_AUCCSF")
  DF_PTA_AUC_df$MIC <- MIC_values
  DF_PTA_AUC_df$Dosing <- DF_event_name  # Add dosing regimen
  DF_PTA_AUC_df$Model <- "DF"  # Add Model column
  
  # Store the PTA results for each event
  DF_AUC_PTA_results[[DF_event_name]] <- DF_PTA_AUC_df
}

# Combine all PTA results into one data frame
DF_AUC_combined_results <- bind_rows(DF_AUC_PTA_results)



combined_results_AUC <- bind_rows(Luque_AUC_combined_results, Li_AUC_combined_results, DF_AUC_combined_results)
combined_results_AUC$Model <- factor(combined_results_AUC$Model, levels = c("Li","Luque", "DF"))































# Now we need to add dosing regimen to the existing Luque simulation outputs
Luque_results <- list()

for (Luque_event_name in names(Luque_events)) {
  Luque_ev_current <- Luque_events[[Luque_event_name]]
  
  # Run the simulation for the current event
  Luque_out <- Luque_mod %>%
    ev(Luque_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Add Dosing Regimen and Model Name to Luque_out
  Luque_out_data <- Luque_out@data %>%
    mutate(Dosing = Luque_event_name, Model = "Luque")
  
  # Store the results
  Luque_results[[Luque_event_name]] <- Luque_out_data
}

# Combine all results from the Luque model into a single data frame
Luque_combined_results <- bind_rows(Luque_results)





# Define the Li model
Li_mod <- mrgsolve::mcode("Li_optim", Li, atol=1e-8, rtol=1e-8, maxsteps=5000)

# Define the dosing events for Li (similar to Luque)
Li_events <- list(
  `600q12h` = ev(amt = 600, rate = 600, cmt = 1, ii = 12, addl = 20),
  `600q8h` = ev(amt = 600, rate = 600, cmt = 1, ii = 8, addl = 20),
  `600q6h` = ev(amt = 600, rate = 600, cmt = 1, ii = 6, addl = 20),
  `1200q24hCI` = ev(amt = 4800, rate = 50, cmt = 1, ii = 0, addl = 0),
  `1800q24hCI` = ev(amt = 7200, rate = 75, cmt = 1, ii = 0, addl = 0),
  `2400q24hCI` = ev(amt = 9600, rate = 100, cmt = 1, ii = 0, addl = 0)
)

n_individuals <- 1000
Li_results <- list()
Li_model_name <- "Li"  # Add the model name here

for (Li_event_name in names(Li_events)) {
  Li_ev_current <- Li_events[[Li_event_name]]
  
  # Run the simulation for the current event
  Li_out <- Li_mod %>%
    ev(Li_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Add Dosing Regimen and Model Name to Li_out
  Li_out_data <- Li_out@data %>%
    mutate(Dosing = Li_event_name, Model = Li_model_name)
  
  # Store the results
  Li_results[[Li_event_name]] <- Li_out_data
}

# Combine all results from the Li model into a single data frame
Li_combined_results <- bind_rows(Li_results)



# Define the DF model
DF_mod <- mrgsolve::mcode("DF_optim", DF, atol=1e-8, rtol=1e-8, maxsteps=5000)

# Define the dosing events for DF (similar to Luque)
DF_events <- list(
  `600q12h` = ev(amt = 600, rate = 1200, cmt = 1, ii = 12, addl = 20),
  `600q8h` = ev(amt = 600, rate = 1200, cmt = 1, ii = 8, addl = 20),
  `600q6h` = ev(amt = 600, rate = 1200, cmt = 1, ii = 6, addl = 20),
  `1200q24hCI` = ev(amt = 4800, rate = 50, cmt = 1, ii = 0, addl = 0),
  `1800q24hCI` = ev(amt = 7200, rate = 75, cmt = 1, ii = 0, addl = 0),
  `2400q24hCI` = ev(amt = 9600, rate = 100, cmt = 1, ii = 0, addl = 0)
)

n_individuals <- 1000
DF_results <- list()
DF_model_name <- "DF"  # Add the model name here

for (DF_event_name in names(DF_events)) {
  DF_ev_current <- DF_events[[DF_event_name]]
  
  # Run the simulation for the current event
  DF_out <- DF_mod %>%
    ev(DF_ev_current) %>%
    mrgsim(nid = n_individuals, delta = 0.1, end = 96, obsonly = TRUE)
  
  # Add Dosing Regimen and Model Name to DF_out
  DF_out_data <- DF_out@data %>%
    mutate(Dosing = DF_event_name, Model = DF_model_name)
  
  # Store the results
  DF_results[[DF_event_name]] <- DF_out_data
}

# Combine all results from the DF model into a single data frame
DF_combined_results <- bind_rows(DF_results)









# Combine Li and Luque results into a single data frame
combined_results_sim <- bind_rows(Li_combined_results, Luque_combined_results,DF_combined_results)


# Filter data where time is between 72 and 96 hours, then group and summarize
min_values <- combined_results_sim %>%
  filter(time >= 72 & time <= 96) %>%
  group_by(Dosing, Model, ID) %>%
  summarise(
    min_DVf = min(DVf, na.rm = TRUE),
    min_DVCSF = min(DVCSF, na.rm = TRUE),
    AUCP_72_96 = max(AUCP) - min(AUCP),
    AUCCSF_72_96 = max(AUCCSF) - min(AUCCSF)
  ) %>%
  # Reorder Model as "Li", "Luque", "DF"
  mutate(Dosing = factor(Dosing,levels = c("600q12h", "600q8h", "600q6h","1200q24hCI", "1800q24hCI", "2400q24hCI")),
Model = factor(Model, levels = c("Li", "Luque", "DF")))


min_values <- min_values %>%
  mutate(
    min_DVf = round(min_DVf, 2),          # Round min_DVf to 2 decimal places
    min_DVCSF = round(min_DVCSF, 2),      # Round min_DVCSF to 2 decimal places
    AUCP_72_96 = round(AUCP_72_96, 0),  # Round AUC for plasma to whole numbers
    AUCCSF_72_96 = round(AUCCSF_72_96, 0)  # Round AUC for CSF to whole numbers
  )


custom_breaks <- c(10, 30, 50, 100, 300, 500, 1000)
y_limits <- c(10,1000)
# Plasma AUC Plot
Plasma_AUC <- ggplot(min_values, aes(x = Dosing, y = AUCP_72_96, fill = Model)) +
  geom_violin(position = position_dodge(width = 0.85), alpha = 0.3, color = "black", linewidth = 1.5) +  
  geom_boxplot(width = 0.2, position = position_dodge(width = 0.85), alpha = 0.7, 
               outlier.shape = NA, color = "black", linewidth = 1.2) +  
  labs(
    title = "Plasma AUC according to Dosing Regimen and Model",
    x = "Dosing Regimen",
    y = "AUC at steady state (mg/L.h)"
  ) +
  scale_fill_jco() +  
  scale_color_jco() +  
  scale_y_log10(breaks = custom_breaks, limits = y_limits, labels = scales::comma_format()) +
  my_theme  

# CSF AUC Plot
CSF_AUC <- ggplot(min_values, aes(x = Dosing, y = AUCCSF_72_96, fill = Model)) +
  geom_violin(position = position_dodge(width = 0.85), alpha = 0.3, color = "black", linewidth = 1.5) +  
  geom_boxplot(width = 0.2, position = position_dodge(width = 0.85), alpha = 0.7, 
               outlier.shape = NA, color = "black", linewidth = 1.2) +  
  labs(
    title = "CSF AUC according to Dosing Regimen and Model",
    x = "Dosing Regimen",
    y = "AUC at steady state (mg/L.h)"
  ) +
  scale_fill_jco() +  
  scale_color_jco() +  
  scale_y_log10(breaks = custom_breaks, limits = y_limits, labels = scales::comma_format()) +
  my_theme  

# Combine plots (unchanged)
combined_plot_AUC <- ggarrange(
  Plasma_AUC, CSF_AUC, 
  ncol = 1, nrow = 2,  
  labels = c("A", "B"),  
  common.legend = TRUE,  
  legend = "top"
)

# Save combined plot
png("C:/Users/thomas.duflot/Desktop/LZD/R2/AUC_Plot.png", width = 20, height = 12, units = 'in', res = 900)  
print(combined_plot_AUC)
dev.off()

custom_breaks <- c(0.1,0.3,0.5,1,3,5,10,30,50)
y_limits <- c(0.01,50)

min_values <- min_values %>%
  mutate(
    min_DVf = ifelse(min_DVf == 0, 0.01, min_DVf),
    min_DVCSF = ifelse(min_DVCSF == 0, 0.01, min_DVCSF)
  )


# Plasma Cmin Plot
Plasma_Cmin <- ggplot(min_values, aes(x = Dosing, y = min_DVf, fill = Model)) +
  geom_violin(position = position_dodge(width = 0.85), alpha = 0.3, color = "black", linewidth = 1.5) +  
  geom_boxplot(width = 0.2, position = position_dodge(width = 0.85), alpha = 0.7, 
               outlier.shape = NA, color = "black", linewidth = 1.2) +  
  labs(
    title = "Plasma Cmin according to Dosing Regimen and Model",
    x = "Dosing Regimen",
    y = "Cmin at steady state (mg/L)"
  ) +
  scale_fill_jco() +  
  scale_color_jco() +  
  scale_y_log10(breaks = custom_breaks, limits = y_limits, labels = scales::comma_format()) +
  my_theme  

# CSF Cmin Plot
CSF_Cmin <- ggplot(min_values, aes(x = Dosing, y = min_DVCSF, fill = Model)) +
  geom_violin(position = position_dodge(width = 0.85), alpha = 0.3, color = "black", linewidth = 1.5) +  
  geom_boxplot(width = 0.2, position = position_dodge(width = 0.85), alpha = 0.7, 
               outlier.shape = NA, color = "black", linewidth = 1.2) +  
  labs(
    title = "CSF Cmin according to Dosing Regimen and Model",
    x = "Dosing Regimen",
    y = "Cmin at steady state (mg/L)"
  ) +
  scale_fill_jco() +  
  scale_color_jco() +
  scale_y_log10(breaks = custom_breaks, limits = y_limits, labels = scales::comma_format()) +  
  my_theme  

# Combine plots (unchanged)
combined_plot_Cmin <- ggarrange(
  Plasma_Cmin, CSF_Cmin, 
  ncol = 1, nrow = 2,  
  labels = c("A", "B"),  
  common.legend = TRUE,  
  legend = "top"
)



# Save combined plot
png("C:/Users/thomas.duflot/Desktop/LZD/R2/Cmin_Plotv2.png", width = 20, height = 12, units = 'in', res = 900)  
print(combined_plot_Cmin)
dev.off()








# Compute statistics (including 5th-95th percentile)
summary_stats <- min_values %>%
  group_by(Dosing, Model) %>%
  summarise(
    Median_AUCP = median(AUCP_72_96),
    Q1_AUCP = quantile(AUCP_72_96, 0.25),
    Q3_AUCP = quantile(AUCP_72_96, 0.75),
    P5_AUCP = quantile(AUCP_72_96, 0.05),
    P95_AUCP = quantile(AUCP_72_96, 0.95),

    Median_AUCCSF = median(AUCCSF_72_96),
    Q1_AUCCSF = quantile(AUCCSF_72_96, 0.25),
    Q3_AUCCSF = quantile(AUCCSF_72_96, 0.75),
    P5_AUCCSF = quantile(AUCCSF_72_96, 0.05),
    P95_AUCCSF = quantile(AUCCSF_72_96, 0.95),

    Median_DVf = median(min_DVf),
    Q1_DVf = quantile(min_DVf, 0.25),
    Q3_DVf = quantile(min_DVf, 0.75),
    P5_DVf = quantile(min_DVf, 0.05),
    P95_DVf = quantile(min_DVf, 0.95),

    Median_DVCSF = median(min_DVCSF),
    Q1_DVCSF = quantile(min_DVCSF, 0.25),
    Q3_DVCSF = quantile(min_DVCSF, 0.75),
    P5_DVCSF = quantile(min_DVCSF, 0.05),
    P95_DVCSF = quantile(min_DVCSF, 0.95),
    .groups = 'drop'
  ) %>%
  mutate(
    Dosing = factor(Dosing, levels = c("600q12h", "600q8h", "600q6h", 
                                       "1200q24hCI", "1800q24hCI", "2400q24hCI")),
    Model = factor(Model, levels = c("Li", "Luque", "DF"))
  ) %>%
  arrange(Dosing, Model) %>%
  mutate(
    `Plasma AUC (mg/L.h)` = sprintf("%.0f [%.0f-%.0f] (%.0f-%.0f)",
                                    Median_AUCP, Q1_AUCP, Q3_AUCP, P5_AUCP, P95_AUCP),
    `CSF AUC (mg/L.h)` = sprintf("%.0f [%.0f-%.0f] (%.0f-%.0f)",
                                  Median_AUCCSF, Q1_AUCCSF, Q3_AUCCSF, P5_AUCCSF, P95_AUCCSF),
    `Plasma Cmin (mg/L)` = sprintf("%.1f [%.1f-%.1f] (%.1f-%.1f)",
                                   Median_DVf, Q1_DVf, Q3_DVf, P5_DVf, P95_DVf),
    `CSF Cmin (mg/L)` = sprintf("%.1f [%.1f-%.1f] (%.1f-%.1f)",
                                 Median_DVCSF, Q1_DVCSF, Q3_DVCSF, P5_DVCSF, P95_DVCSF)
  ) %>%
  select(Dosing, Model, 
         `Plasma AUC (mg/L.h)`, 
         `CSF AUC (mg/L.h)`, 
         `Plasma Cmin (mg/L)`, 
         `CSF Cmin (mg/L)`)

# Create flextable
summary_table <- flextable(summary_stats) %>%
  theme_vanilla() %>% 
  bold(part = "header") %>%
  align(align = "center", part = "header") %>%
  align(align = "right", part = "body") %>%
  merge_v(j = "Dosing") %>%  
  autofit() %>%
  fontsize(size = 10, part = "all")

# Export as Word document
doc <- read_docx() %>%
  body_add_flextable(value = summary_table)

print(doc, target = "summary_stats_table.docx")


summary_data_Plasma <- combined_results_sim %>%
  group_by(Model, Dosing, time) %>%
  summarize(
    median_DVf = median(DVf),
    lower_IQR = quantile(DVf, 0.25),
    upper_IQR = quantile(DVf, 0.75),
    lower_5th = quantile(DVf, 0.05),
    upper_95th = quantile(DVf, 0.95),
    .groups = 'drop'
  )

summary_data_Plasma$Dosing <- factor(summary_data_Plasma$Dosing, levels = c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI"))
summary_data_Plasma$Model <- factor(summary_data_Plasma$Model, levels = c("Li", "Luque", "DF"))



# Set JCO colors
jco_colors <- pal_jco()(3)

# Set custom Y-axis scale
custom_y_scale <- scale_y_continuous(breaks = c(0, 5, 10, 15, 20,25,30,35), limits = c(0, 36))


SimDosing_Plasma_Luque <- summary_data_Plasma %>%
  filter(Model == "Luque") %>%
  ggplot(aes(x = time, y = median_DVf)) +
  geom_ribbon(aes(ymin = lower_5th, ymax = upper_95th), alpha = 0.2, fill = jco_colors[2]) +
  geom_ribbon(aes(ymin = lower_IQR, ymax = upper_IQR), alpha = 0.4, fill = jco_colors[2]) +
  geom_line(size = 1.5, color = jco_colors[2]) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("Time (hours)") + ylab("LZD (mg/L)") +
  ggtitle("LZD PK Profile in Plasma - Luque") +
  custom_y_scale +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"), panel.spacing.y = unit(1, "lines"))

SimDosing_Plasma_Li <- summary_data_Plasma %>%
  filter(Model == "Li") %>%
  ggplot(aes(x = time, y = median_DVf)) +
  geom_ribbon(aes(ymin = lower_5th, ymax = upper_95th), alpha = 0.2, fill = jco_colors[1]) +
  geom_ribbon(aes(ymin = lower_IQR, ymax = upper_IQR), alpha = 0.4, fill = jco_colors[1]) +
  geom_line(size = 1.5, color = jco_colors[1]) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("Time (hours)") + ylab("LZD (mg/L)") +
  ggtitle("LZD PK Profile in Plasma - Li") +
  custom_y_scale +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"), panel.spacing.y = unit(1, "lines"))

SimDosing_Plasma_DF <- summary_data_Plasma %>%
  filter(Model == "DF") %>%
  ggplot(aes(x = time, y = median_DVf)) +
  geom_ribbon(aes(ymin = lower_5th, ymax = upper_95th), alpha = 0.2, fill = jco_colors[3]) +
  geom_ribbon(aes(ymin = lower_IQR, ymax = upper_IQR), alpha = 0.4, fill = jco_colors[3]) +
  geom_line(size = 1.5, color = jco_colors[3]) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("Time (hours)") + ylab("LZD (mg/L)") +
  ggtitle("LZD PK Profile in Plasma - DF") +
  custom_y_scale +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"), panel.spacing.y = unit(1, "lines"))



# Finally, arrange the three separate plots (one per model)
combined_plot_Sim_Plasma <- ggarrange(
  SimDosing_Plasma_Li,  
SimDosing_Plasma_Luque,
  SimDosing_Plasma_DF,
  ncol = 3, nrow = 1,
  labels = c("A", "B", "C"),
  common.legend = FALSE
)


# Save or print as needed
print(combined_plot_Sim_Plasma)

# Save combined plot
png("C:/Users/thomas.duflot/Desktop/LZD/R2/Combined_plot_Sim_Plasma.png", width = 20, height = 12, units = 'in', res = 900)  
print(combined_plot_Sim_Plasma)
dev.off()










# Summarize the data by time, model, and dosing regimen
summary_data_CSF <- combined_results_sim %>%
  group_by(Model, Dosing, time) %>%
  summarize(
    median_DVCSF = median(DVCSF),
    lower_IQR = quantile(DVCSF, 0.25),
    upper_IQR = quantile(DVCSF, 0.75),
    lower_5th = quantile(DVCSF, 0.05),
    upper_95th = quantile(DVCSF, 0.95),
    .groups = 'drop'
  )


summary_data_CSF$Dosing <- factor(summary_data_CSF$Dosing, levels = c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI"))
summary_data_CSF$Model <- factor(summary_data_CSF$Model, levels = c("Li", "Luque", "DF")) 

SimDosing_CSF_Luque <- summary_data_CSF %>%
  filter(Model == "Luque") %>%
  ggplot(aes(x = time, y = median_DVCSF)) +
  geom_ribbon(aes(ymin = lower_5th, ymax = upper_95th), alpha = 0.2, fill = jco_colors[2]) +
  geom_ribbon(aes(ymin = lower_IQR, ymax = upper_IQR), alpha = 0.4, fill = jco_colors[2]) +
  geom_line(size = 1.5, color = jco_colors[2]) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("Time (hours)") + ylab("LZD (mg/L)") +
  ggtitle("LZD PK Profile in CSF - Luque") +
  custom_y_scale +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"), panel.spacing.y = unit(1, "lines"))

SimDosing_CSF_Li <- summary_data_CSF %>%
  filter(Model == "Li") %>%
  ggplot(aes(x = time, y = median_DVCSF)) +
  geom_ribbon(aes(ymin = lower_5th, ymax = upper_95th), alpha = 0.2, fill = jco_colors[1]) +
  geom_ribbon(aes(ymin = lower_IQR, ymax = upper_IQR), alpha = 0.4, fill = jco_colors[1]) +
  geom_line(size = 1.5, color = jco_colors[1]) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("Time (hours)") + ylab("LZD (mg/L)") +
  ggtitle("LZD PK Profile in CSF - Li") +
  custom_y_scale +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"), panel.spacing.y = unit(1, "lines"))

SimDosing_CSF_DF <- summary_data_CSF %>%
  filter(Model == "DF") %>%
  ggplot(aes(x = time, y = median_DVCSF)) +
  geom_ribbon(aes(ymin = lower_5th, ymax = upper_95th), alpha = 0.2, fill = jco_colors[3]) +
  geom_ribbon(aes(ymin = lower_IQR, ymax = upper_IQR), alpha = 0.4, fill = jco_colors[3]) +
  geom_line(size = 1.5, color = jco_colors[3]) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("Time (hours)") + ylab("LZD (mg/L)") +
  ggtitle("LZD PK Profile in CSF - DF") +
  custom_y_scale +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"), panel.spacing.y = unit(1, "lines"))


combined_plot_Sim_CSF <- ggarrange(
  SimDosing_CSF_Li,  
SimDosing_CSF_Luque,
  SimDosing_CSF_DF,
  ncol = 3, nrow = 1,
  labels = c("D", "E", "F"),
  common.legend = FALSE
)

# Display or save the plot
png("C:/Users/thomas.duflot/Desktop/LZD/R2/Combined_plot_Sim_CSF.png", width = 20, height = 12, units = 'in', res = 900)  
print(combined_plot_Sim_CSF)
dev.off()








empty_plot <- ggplot() + theme_void()

combined_plot_Sim <- ggarrange(
  # Put your two main plots in one column
  ggarrange(combined_plot_Sim_Plasma, 
            combined_plot_Sim_CSF,
            ncol = 1, nrow = 2,
            labels = c("",""),
            common.legend = TRUE,
            legend = "top"),
  # Next, the empty plot as a narrow 2nd column
  empty_plot,
  ncol = 2,
  widths = c(1, 0.01)   # 5% width for the empty column
)

print(combined_plot_Sim)

png("C:/Users/thomas.duflot/Desktop/LZD/R2/Sim_Plot.png", width = 24, height = 12, units = 'in', res = 900)  # Specify width, height, and resolution

# Print the plot to the device
print(combined_plot_Sim)

# Close the device
dev.off()








combined_PTA_AUC_results<-combined_results_AUC



combined_PTA_AUC_results$Dosing <- factor(combined_PTA_AUC_results$Dosing, levels = c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI"))
combined_results_fT$Dosing <- factor(combined_results_fT$Dosing, levels = c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI"))


# Define the MIC values
MIC_values <- c(0.002, 0.004, 0.008, 0.016, 0.03, 0.06, 0.125, 0.25, 0.5, 1, 2, 4, 8, 16, 32, 64, 128, 256, 512)

# Summing distributions for Staphylococcus spp. (includes aureus, MRSA, MSSA, epidermidis, etc.)
mic_staphylococcus <- c(0, 0, 0, 0, 0, 14, 160, 220, 1886, 20605, 40954, 6736, 42, 28, 10, 2, 1, 0, 0)  # Example total across species

# Summing distributions for Enterococcus spp. (includes faecalis, faecium, etc.)
mic_enterococcus <- c(0, 0, 0, 0, 0, 0, 24, 63, 1026, 18608, 25193, 876, 30, 10, 8, 0, 0, 0, 0)  # Summed

# Cutibacterium acnes
mic_cutibacterium_acnes <- c(0, 0, 0, 0, 0, 0, 0, 18, 184, 96, 6, 0, 0, 0, 0, 0, 0, 0, 0)

# Summing distributions for Streptococcus spp. (includes pneumoniae, pyogenes, etc.)
mic_streptococcus <- c(0, 0, 0, 0, 0, 21, 297, 882, 9294, 63598, 19792, 31, 1, 0, 0, 0, 0, 0, 0)  # Summed

# Create a data frame with summed distributions
mic_distribution <- data.frame(
  MIC_value = MIC_values,
  Staphylococcus_spp = mic_staphylococcus,
  Enterococcus_spp = mic_enterococcus,
  Cutibacterium_acnes = mic_cutibacterium_acnes,
  Streptococcus_spp = mic_streptococcus
)

# Calculate the average MIC distribution across the genera
mic_distribution$Average_MIC <- rowMeans(mic_distribution[, 2:5], na.rm = TRUE)

# View the MIC distribution table
print(mic_distribution)

# Define the MIC values
MIC_values <- c(0.002, 0.004, 0.008, 0.016, 0.03, 0.06, 0.125, 0.25, 0.5, 1, 2, 4, 8, 16, 32, 64, 128, 256, 512)

# Summing distributions for all species
mic_staphylococcus <- c(0, 0, 0, 0, 0, 14, 160, 220, 1886, 20605, 40954, 6736, 42, 28, 10, 2, 1, 0, 0)
mic_enterococcus <- c(0, 0, 0, 0, 0, 0, 24, 63, 1026, 18608, 25193, 876, 30, 10, 8, 0, 0, 0, 0)
mic_cutibacterium_acnes <- c(0, 0, 0, 0, 0, 0, 0, 18, 184, 96, 6, 0, 0, 0, 0, 0, 0, 0, 0)
mic_streptococcus <- c(0, 0, 0, 0, 0, 21, 297, 882, 9294, 63598, 19792, 31, 1, 0, 0, 0, 0, 0, 0)

# Sum across all species
mic_total_distribution <- mic_staphylococcus + mic_enterococcus + mic_cutibacterium_acnes + mic_streptococcus

# Create a data frame with the summed distribution
mic_distribution_total <- data.frame(
  MIC_value = MIC_values,
  Total_Distribution = mic_total_distribution
)

# View the total MIC distribution
print(mic_distribution_total)




# Filter MIC values between 0.25 and 32
filtered_mic_distribution <- mic_distribution_total %>%
  filter(MIC_value >= 0.25 & MIC_value <= 32)

# View the filtered MIC distribution
print(filtered_mic_distribution)



# Calculate the total count within this range
total_count <- sum(filtered_mic_distribution$Total_Distribution)

# Calculate the frequency as a percentage
filtered_mic_distribution <- filtered_mic_distribution %>%
  mutate(Percent_Frequency = (Total_Distribution / total_count) * 100)

# View the updated MIC distribution with percentages
print(filtered_mic_distribution)




# Assuming the filtered_mic_distribution contains the MIC frequencies
# Merge MIC frequency data with PTA data (combined_PTA_AUC_results)
combined_PTA_AUC_results <- merge(combined_results_AUC, filtered_mic_distribution, by.x = "MIC", by.y = "MIC_value")
combined_PTA_AUC_results$Dosing <- factor(combined_PTA_AUC_results$Dosing, levels = c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI"))

# First, add a new column to combined_PTA_AUC_results to represent the MIC distribution category
combined_PTA_AUC_results$MIC_Distribution <- "MIC Frequency (%)"

# Create the PTA plot for AUC/MIC > 100 for plasma
PTA_AUC_Plasma <- ggplot(combined_PTA_AUC_results  %>% filter(Model == "Li"), aes(x = factor(MIC))) + 
  geom_bar(aes(y = Percent_Frequency, fill = MIC_Distribution), stat = "identity", alpha = 0.8, width = 0.75) +  # MIC frequency as bars (only for Li or Luque model)
  geom_line(data = combined_PTA_AUC_results, aes(x = factor(MIC), y = PTA_AUCP, group = Model, color = Model), size = 1.5) +  # Line plot for PTA curves for both models
  geom_point(data = combined_PTA_AUC_results, aes(x = factor(MIC), y = PTA_AUCP, shape = Model), color = "black", size = 3) +  # Black points with different shapes for both models
  geom_hline(yintercept = 90, linetype = "dashed", color = "black", size = 1.5) +  # Dashed line at 90% PTA
  scale_color_jco() +  # Use the JCO color scheme
  scale_fill_manual(values = c("MIC Frequency (%)" = "darkgray"), name = "") +  # Set color for MIC distribution bars, customize legend
  scale_y_continuous(name = "PTA (%)", breaks = seq(0, 100, by = 10)) +  # Remove secondary axis
  facet_wrap(~ Dosing, scales = "free_x") +  # Facet by reordered dosing regimen with free x-axis scaling
  xlab("MIC (mg/L)") + 
  ylab("PTA (%) ") +
  ggtitle("PTA (AUC/MIC > 100 for plasma LZD concentration)") + 
  my_theme + 
  theme(
    strip.background = element_blank(),   # Clean up facet strip background
    strip.placement = "outside",          # Position facet strips outside the plot
    axis.text.y.right = element_text(color = "gray"),  # Make the right y-axis text gray to match the bars
    legend.title = element_text(size = 12),  # Customize the size of the legend title
    legend.position = "top"               # Position legend at the top
  )

# Create the PTA plot for AUC/MIC > 100 for CSF with MIC frequency as bars (same approach)
PTA_AUC_CSF <- ggplot(combined_PTA_AUC_results %>% filter(Model == "Li"), aes(x = factor(MIC))) + 
  geom_bar(aes(y = Percent_Frequency, fill = MIC_Distribution), stat = "identity", alpha = 0.5, width = 0.75) +  # MIC frequency as bars (only for Li or Luque model)
  geom_line(data = combined_PTA_AUC_results, aes(x = factor(MIC), y = PTA_AUCCSF, group = Model, color = Model), size = 1.5) +  # Line plot for PTA curves for both models
  geom_point(data = combined_PTA_AUC_results, aes(x = factor(MIC), y = PTA_AUCCSF, shape = Model), color = "black", size = 3) +  # Black points with different shapes for both models
  geom_hline(yintercept = 90, linetype = "dashed", color = "black", size = 1.5) +  # Dashed line at 90% PTA
  scale_color_jco() +  # Use the JCO color scheme
  scale_fill_manual(values = c("MIC Frequency (%)" = "darkgray"), name = "") +  # Set color for MIC distribution bars, customize legend
  scale_y_continuous(name = "PTA (%)", breaks = seq(0, 100, by = 10)) +  # Remove secondary axis
  facet_wrap(~ Dosing, scales = "free_x") +  # Facet by reordered dosing regimen with free x-axis scaling
  xlab("MIC (mg/L)") + 
  ylab("PTA (%) and MIC Distribution (%)") +
  ggtitle("PTA (AUC/MIC > 100 for CSF LZD concentration)") + 
  my_theme + 
  theme(
    strip.background = element_blank(),   # Clean up facet strip background
    strip.placement = "outside",          # Position facet strips outside the plot
    axis.text.y.right = element_text(color = "gray"),  # Make the right y-axis text gray to match the bars
    legend.title = element_text(size = 12),  # Customize the size of the legend title
    legend.position = "top"               # Position legend at the top
  )

# Combine both plots
combined_plot_PTA <- ggarrange(PTA_AUC_Plasma, PTA_AUC_CSF, 
                               ncol = 1, nrow = 2,  # Arrange plots vertically
                               labels = c("A", "B"),  # Add labels to the plots (optional)
                               common.legend = TRUE,  # Use a common legend for both plots
                               legend = "top")  # Position the legend at the top



png("C:/Users/thomas.duflot/Desktop/LZD/R2/PTA_AUC_Plot_MIC.png", width = 12, height = 16, units = 'in', res = 900)  # Specify width, height, and resolution

# Print the plot to the device
print(combined_plot_PTA)

# Close the device
dev.off()




# Merge the combined results with the MIC frequency table
# Assuming you merged filtered_mic_distribution with combined_results_fT
# Create the PTA plot for fT > MIC for plasma


# Merge the combined results with the MIC frequency table
combined_results_fT <- merge(combined_results_fT, filtered_mic_distribution, by.x = "MIC", by.y = "MIC_value")
combined_results_fT$Dosing <- factor(combined_results_fT$Dosing, levels = c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI"))
combined_results_fT$MIC_Distribution <- "MIC Frequency (%)"

# Make sure to load necessary packages and define 'my_theme' first.
# We'll show the relevant parts focusing on the legend ordering.

# PTA fT>MIC 85% – plasma
PTA_fT_Plasma <- ggplot(combined_results_fT %>% filter(Model == "Li"), 
                        aes(x = factor(MIC))) + 
  geom_bar(aes(y = Percent_Frequency, fill = MIC_Distribution),
           stat = "identity", alpha = 0.8, width = 0.75) +
  geom_line(data = combined_results_fT,
            aes(x = factor(MIC), y = PTA_DVf, group = Model, color = Model),
            size = 1.5) +
  geom_point(data = combined_results_fT,
             aes(x = factor(MIC), y = PTA_DVf, shape = Model),
             color = "black", size = 3) +
  geom_hline(yintercept = 90, linetype = "dashed", color = "black", size = 1.5) +
  scale_color_jco(name = "Model") +
  scale_fill_manual(values = c("MIC Frequency (%)" = "darkgray"), name = "") +
  scale_shape_manual(values = c("Li" = 16, "Luque" = 17, "DF" = 15),
                     name = "Model") +
  scale_y_continuous(name = "PTA (%)", breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("MIC (mg/L)") +
  ylab("PTA (%)") +
  ggtitle("PTA (%T > MIC 85% pour LZD plasmatique)") +
  my_theme +
  theme(
    strip.background  = element_blank(),
    strip.placement   = "outside",
    legend.position   = "top"
  )

# PTA fT>MIC 85% – CSF
PTA_fT_CSF <- ggplot(combined_results_fT %>% filter(Model == "Li"), 
                     aes(x = factor(MIC))) + 
  geom_bar(aes(y = Percent_Frequency, fill = MIC_Distribution),
           stat = "identity", alpha = 0.8, width = 0.75) +
  geom_line(data = combined_results_fT,
            aes(x = factor(MIC), y = PTA_DVCSF, group = Model, color = Model),
            size = 1.5) +
  geom_point(data = combined_results_fT,
             aes(x = factor(MIC), y = PTA_DVCSF, shape = Model),
             color = "black", size = 3) +
  geom_hline(yintercept = 90, linetype = "dashed", color = "black", size = 1.5) +
  scale_color_jco(name = "Model") +
  scale_fill_manual(values = c("MIC Frequency (%)" = "darkgray"), name = "") +
  scale_shape_manual(values = c("Li" = 16, "Luque" = 17, "DF" = 15),
                     name = "Model") +
  scale_y_continuous(name = "PTA (%)", breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ Dosing, scales = "free_x") +
  xlab("MIC (mg/L)") +
  ylab("PTA (%)") +
  ggtitle("PTA (%T > MIC 85% pour LZD en LCR)") +
  my_theme +
  theme(
    strip.background  = element_blank(),
    strip.placement   = "outside",
    legend.position   = "top"
  )

# Combine panels
combined_plot_PTA_fT <- ggarrange(
  PTA_fT_Plasma, PTA_fT_CSF,
  ncol = 1, nrow = 2,
  labels = c("A", "B"),
  common.legend = TRUE,
  legend = "top"
)


png("C:/Users/thomas.duflot/Desktop/LZD/R2/PTA_PercT_MIC.png", 
    width = 12, height = 16, units = 'in', res = 900)
print(combined_plot_PTA_fT)
dev.off()




long_data <- mic_distribution %>%
  select(-Average_MIC) %>%  # Exclude the Average_MIC column
  tidyr::pivot_longer(
    cols = c("Staphylococcus_spp", "Enterococcus_spp", "Cutibacterium_acnes", "Streptococcus_spp"),
    names_to = "Species",
    values_to = "Count"
  )

# Calculate the total count per species for frequency calculation
long_data <- long_data %>%
  group_by(Species) %>%
  mutate(Frequency = Count / sum(Count) * 100)  # Calculate percentage frequency



MIC_data <- data.frame(
  MIC_value = c(0.002, 0.004, 0.008, 0.016, 0.030, 0.060, 0.125, 0.250, 0.500, 1.000, 2.000, 4.000, 8.000, 16.000, 32.000, 64.000, 128.000, 256.000, 512.000),
  Staphylococcus_spp = c(0, 0, 0, 0, 0, 14, 160, 220, 1886, 20605, 40954, 6736, 42, 28, 10, 2, 1, 0, 0),
  Enterococcus_spp = c(0, 0, 0, 0, 0, 0, 24, 63, 1026, 18608, 25193, 876, 30, 10, 8, 0, 0, 0, 0),
  Cutibacterium_acnes = c(0, 0, 0, 0, 0, 0, 0, 18, 184, 96, 6, 0, 0, 0, 0, 0, 0, 0, 0),
  Streptococcus_spp = c(0, 0, 0, 0, 0, 21, 297, 882, 9294, 63598, 19792, 31, 1, 0, 0, 0, 0, 0, 0)
)

# Convert data of each column to percentage of total
MIC_data_pct <- MIC_data
MIC_data_pct$Staphylococcus_spp <- (MIC_data$Staphylococcus_spp / sum(MIC_data$Staphylococcus_spp)) * 100
MIC_data_pct$Enterococcus_spp <- (MIC_data$Enterococcus_spp / sum(MIC_data$Enterococcus_spp)) * 100
MIC_data_pct$Cutibacterium_acnes <- (MIC_data$Cutibacterium_acnes / sum(MIC_data$Cutibacterium_acnes)) * 100
MIC_data_pct$Streptococcus_spp <- (MIC_data$Streptococcus_spp / sum(MIC_data$Streptococcus_spp)) * 100

# Display the data
print(MIC_data_pct)


MIC_data_melt <- melt(MIC_data_pct, id.vars = "MIC_value", 
                      variable.name = "Species", 
                      value.name = "Percentage")

# Convert MIC_value to factor
MIC_data_melt$MIC_value <- as.factor(MIC_data_melt$MIC_value)



total_distribution <- data.frame(
  MIC_value = c(0.002, 0.004, 0.008, 0.016, 0.030, 0.060, 0.125, 0.250, 
                0.500, 1.000, 2.000, 4.000, 8.000, 16.000, 32.000, 
                64.000, 128.000, 256.000, 512.000),
  Total_Distribution = c(0, 0, 0, 0, 0, 35, 481, 1183, 
                         12390, 102907, 85945, 7643, 73, 38, 
                         18, 2, 1, 0, 0)
)

# Filter total_distribution to only include MIC_value between 0.25 and 32
total_distribution <- total_distribution %>%
  filter(MIC_value >= 0.25 & MIC_value <= 32)

# Calculate percentage for the total distribution
total_sum <- sum(total_distribution$Total_Distribution)  # Total of the counts
total_distribution <- total_distribution %>%
  mutate(Percentage = (Total_Distribution / total_sum) * 100)

# Convert MIC_value to factor for the total distribution
total_distribution$MIC_value <- as.factor(total_distribution$MIC_value)

# Create a Species column for the total distribution
total_distribution$Species <- "Total Distribution"

# Melt the original data into long format
MIC_data_melt <- melt(MIC_data_pct, id.vars = "MIC_value", 
                      variable.name = "Species", 
                      value.name = "Percentage")

# Convert MIC_value to factor
MIC_data_melt$MIC_value <- as.factor(MIC_data_melt$MIC_value)

# Filter for MIC_value between 0.25 and 32 in MIC_data_pct
MIC_data_filtered <- MIC_data_melt %>%
  filter(as.numeric(as.character(MIC_value)) >= 0.25 & as.numeric(as.character(MIC_value)) <= 32)

# Replace underscores with spaces and make species names italic in the legend
MIC_data_filtered$Species <- gsub("_", " ", MIC_data_filtered$Species)

# Combine the filtered data with the total distribution
combined_data <- bind_rows(MIC_data_filtered, total_distribution)

# Create labels with total counts for the subtitle
totals <- MIC_data %>%
  summarise(
    Staphylococcus_spp = sum(Staphylococcus_spp),
    Enterococcus_spp = sum(Enterococcus_spp),
    Cutibacterium_acnes = sum(Cutibacterium_acnes),
    Streptococcus_spp = sum(Streptococcus_spp)
  )

labels <- paste0(c("Staphylococcus spp: ", "Enterococcus spp: ", 
                   "Cutibacterium acnes: ", "Streptococcus spp: ", 
                   "Total: "), 
                 c(as.character(c(totals$Staphylococcus_spp, totals$Enterococcus_spp, 
                                  totals$Cutibacterium_acnes, totals$Streptococcus_spp)),
                   sum(total_distribution$Total_Distribution)))

# Format the subtitle with a line break after the second count
subtitle_text <- paste(labels[1], labels[2], "\n", labels[3], labels[4], "\n", labels[5])


MIC_Distrib <- ggplot() +
  # 1) Big transparent bars for Total Distribution
  geom_bar(
    data = subset(combined_data, Species == "Total Distribution"),
    aes(x = MIC_value, y = Percentage),
    stat = "identity",
    position = "identity",  # so it doesn't dodge
    fill = "black",
    alpha = 0.2  # or 0.3, 0.4, etc. pick your favorite transparency
  ) +
  
  # 2) Individual species bars on top
  geom_bar(
    data = subset(combined_data, Species != "Total Distribution"),
    aes(x = MIC_value, y = Percentage, fill = Species),
    stat = "identity",
    position = position_dodge(width = 0.8)  # side-by-side species
  ) +
  
  # 3) Labels, scales, etc.
  labs(
    title = "Distribution of MIC values and counts for each species", 
    subtitle = subtitle_text,
    x = "MIC Value",
    y = "Percentage (%)"
  ) +
  scale_fill_jco(labels = function(x) lapply(x, function(label) bquote(italic(.(label))))) +
  my_theme +
  theme(
    axis.title = element_text(size = 18, color = "black"),
    axis.text = element_text(size = 16, color = "black"),
    axis.line = element_line(linewidth = 1.5),
    legend.title = element_text(size = 18, color = "black"),
    legend.text = element_text(size = 16, color = "black")
  )

print(MIC_Distrib)




png("C:/Users/thomas.duflot/Desktop/LZD/R2/MIC Distribution.png", width = 12, height = 16, units = 'in', res = 900)  # Specify width, height, and resolution
print(MIC_Distrib)
dev.off()






library(dplyr)
library(tidyr)
library(flextable)
library(officer)

##---------------------------------------------------------------
## Ensure numeric values before reshaping
##---------------------------------------------------------------

# Convert necessary columns to numeric explicitly
combined_results_fT <- combined_results_fT %>%
  mutate(PTA_DVf = as.numeric(PTA_DVf),
         PTA_DVCSF = as.numeric(PTA_DVCSF))

combined_PTA_AUC_results <- combined_PTA_AUC_results %>%
  mutate(PTA_AUCP = as.numeric(PTA_AUCP),
         PTA_AUCCSF = as.numeric(PTA_AUCCSF))

##---------------------------------------------------------------
## Merge fT and AUC datasets for Plasma and CSF
##---------------------------------------------------------------

df_fT_plasma <- combined_results_fT %>%
  transmute(Dosing, Model, MIC, Target = "%T > MIC", Value = as.numeric(PTA_DVf), Matrix = "Plasma")

df_fT_csf <- combined_results_fT %>%
  transmute(Dosing, Model, MIC, Target = "%T > MIC", Value = as.numeric(PTA_DVCSF), Matrix = "CSF")

df_AUC_plasma <- combined_PTA_AUC_results %>%
  transmute(Dosing, Model, MIC, Target = "AUC/MIC > 100", Value = as.numeric(PTA_AUCP), Matrix = "Plasma")

df_AUC_csf <- combined_PTA_AUC_results %>%
  transmute(Dosing, Model, MIC, Target = "AUC/MIC > 100", Value = as.numeric(PTA_AUCCSF), Matrix = "CSF")

# Combine datasets
df_plasma <- bind_rows(df_fT_plasma, df_AUC_plasma)
df_csf <- bind_rows(df_fT_csf, df_AUC_csf)

##---------------------------------------------------------------
## Factorize Dosing and Model correctly
##---------------------------------------------------------------

dose_levels  <- c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI")
model_levels <- c("Li", "Luque", "DF")

df_plasma <- df_plasma %>%
  mutate(
    Dosing = factor(Dosing, levels = dose_levels),
    Model  = factor(Model,  levels = model_levels),
    MIC    = factor(MIC, levels = c(0.25, 0.5, 1, 2, 4, 8))
  ) %>%
  arrange(Dosing, Target, Model, MIC)

df_plasma <- df_plasma %>%
  filter(MIC %in% c(0.25, 0.5, 1, 2, 4, 8))



df_csf <- df_csf %>%
  mutate(
    Dosing = factor(Dosing, levels = dose_levels),
    Model  = factor(Model,  levels = model_levels),
    MIC    = factor(MIC, levels = c(0.25, 0.5, 1, 2, 4, 8))
  ) %>%
  arrange(Dosing, Target, Model, MIC)


df_csf <- df_csf %>%
  filter(MIC %in% c(0.25, 0.5, 1, 2, 4, 8))


##---------------------------------------------------------------
## Pivot Data to Wide Format (Ensure Numeric Values)
##---------------------------------------------------------------

plasma_wide <- df_plasma %>%
  group_by(Dosing, Target, MIC, Model) %>%
  summarise(Value = mean(Value, na.rm = TRUE), .groups = "drop") %>%  # Ensure unique rows
  pivot_wider(
    id_cols = c(Dosing, Target),
    names_from = c(MIC, Model),
    values_from = Value,
    names_sep = "_",
    values_fn = mean  # Aggregate if duplicates exist
  ) 


csf_wide <- df_csf %>%
  group_by(Dosing, Target, MIC, Model) %>%
  summarise(Value = mean(Value, na.rm = TRUE), .groups = "drop") %>% 
  pivot_wider(
    id_cols = c(Dosing, Target),
    names_from = c(MIC, Model),
    values_from = Value,
    names_sep = "_",
    values_fn = mean
  )

##---------------------------------------------------------------
## Construct Multi-Level Headers for Flextable
##---------------------------------------------------------------

make_header_df <- function(col_names) {
  hdr <- data.frame(col_keys = col_names, stringsAsFactors = FALSE)
  hdr$line1 <- ""
  hdr$line2 <- hdr$col_keys

  desired_mics <- c("0.25", "0.5", "1", "2", "4", "8")
  desired_mods <- c("Li", "Luque", "DF")

  for (mic in desired_mics) {
    for (mod in desired_mods) {
      colkey  <- paste0(mic, "_", mod)
      top_lbl <- paste("MIC =", mic)
      bot_lbl <- mod
      hdr$line1[ hdr$col_keys == colkey ] <- top_lbl
      hdr$line2[ hdr$col_keys == colkey ] <- bot_lbl
    }
  }

  hdr$line1[hdr$col_keys == "Dosing"] <- "LZD Dosing Regimen"
  hdr$line2[hdr$col_keys == "Dosing"] <- "Dosing"

  hdr$line1[hdr$col_keys == "Target"] <- "PK-PD Target"
  hdr$line2[hdr$col_keys == "Target"] <- "Target"

  hdr
}

plasma_header <- make_header_df(names(plasma_wide))
csf_header    <- make_header_df(names(csf_wide))

##---------------------------------------------------------------
## Create Flextables with Fixed Numeric Formatting
##---------------------------------------------------------------

make_flex <- function(data_wide, header_df) {
  ft <- flextable(data_wide, col_keys = header_df$col_keys)

  # Set multi-level headers
  ft <- set_header_df(ft, mapping = header_df, key = "col_keys")

  # Merge header cells where needed
  ft <- merge_h(ft, part = "header")  

  # Apply styling
  ft <- ft %>%
    theme_vanilla() %>%
    bold(part = "header") %>%
    align(align = "center", part = "header") %>%
    align(align = "right",  part = "body") %>%
    merge_v(j = "Dosing", part = "body") %>%
    autofit() %>%
    fontsize(size = 10, part = "all")

  # **Custom Number Formatting: Remove .0 from whole numbers**
  format_numbers <- function(x) {
    ifelse(x == round(x), as.character(round(x)), sprintf("%.0f", x))
  }

  # Apply custom formatting to all numeric columns
  numeric_cols <- names(data_wide)[-c(1,2)]  # Skip "Dosing" & "Target"
  for (col in numeric_cols) {
    ft <- colformat_num(ft, j = col, digits = 1)  # Standard rounding
    ft <- flextable::compose(ft, j = col, value = as_paragraph(as_chunk(format_numbers(data_wide[[col]]))))
  }

  return(ft)
}


plasma_flex <- make_flex(plasma_wide, plasma_header)
csf_flex    <- make_flex(csf_wide,    csf_header)



##---------------------------------------------------------------
## Export Flextables to Word Document
##---------------------------------------------------------------

doc <- read_docx() %>%
  body_add_par(value = "Combined Plasma Results", style = "heading 1") %>%
  body_add_flextable(plasma_flex) %>%
  body_add_par(value = "") %>%
  body_add_par(value = "Combined CSF Results", style = "heading 1") %>%
  body_add_flextable(csf_flex)

print(doc, target = "Combined_Plasma_and_CSF.docx")

cat("Word document 'Combined_Plasma_and_CSF.docx' successfully created!\n")






























# Ensure correct order for dosing regimens
dosing_order <- c("600q12h", "600q8h", "600q6h", "1200q24hCI", "1800q24hCI", "2400q24hCI")

# Function to compute CFR for each scenario
compute_CFR <- function(.data, pta_col) {
  .data %>%
    group_by(Dosing, Model, MIC) %>%
    summarize(
      PTA_value = mean(.data[[pta_col]], na.rm = TRUE),
      freq      = mean(Percent_Frequency, na.rm = TRUE),  # Convert frequency to percentage
      .groups   = "drop"
    ) %>%
    group_by(Dosing, Model) %>%
    summarize(
      CFR = sum(PTA_value * freq / 100, na.rm = TRUE),  # Convert to percentage
      .groups = "drop"
    ) %>%
    mutate(
      Model = factor(Model, levels = c("Li", "Luque", "DF")),  # Ensure model order
      Regimen_Type = factor(ifelse(Dosing %in% c("600q12h", "600q8h", "600q6h"), 
                            "Intermittent", "Continuous Infusion"),
                            levels = c("Intermittent", "Continuous Infusion")),  # Ensure correct order
      Dosing = factor(Dosing, levels = dosing_order)  # Ensure dosing regimen order
    )
}

# Compute CFR for each condition
df_CFR_fT_Plasma <- compute_CFR(combined_results_fT, "PTA_DVf")
df_CFR_fT_CSF    <- compute_CFR(combined_results_fT, "PTA_DVCSF")
df_CFR_AUC_Plasma <- compute_CFR(combined_PTA_AUC_results, "PTA_AUCP")
df_CFR_AUC_CSF    <- compute_CFR(combined_PTA_AUC_results, "PTA_AUCCSF")

# Function to create CFR plot
plot_CFR <- function(df, plot_title) {
  ggplot(df, aes(x = Dosing, y = CFR, color = Model, shape = Model, group = Model)) +
    geom_point(size = 4) +                         # Large points for clarity
    geom_line(size = 1.2) +                        # Connect points with lines
    facet_wrap(~ Regimen_Type, scales = "free") + # Facet by administration type (Intermittent first)
    scale_color_jco() +                             # Use JCO color scheme
    scale_shape_manual(values = c(15, 17, 19)) +    # Square, triangle, circle for models
    scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +  
    labs(
      title = plot_title,
      x = "LZD Infusion Regimen",
      y = "CFR (%)"
    ) +
    my_theme + 

    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 45, hjust = 1),  # Tilt x-axis labels for readability
      strip.text = element_text(size = 14, face = "bold")  # Bold facet titles
    )+ theme(
    panel.spacing.x = unit(2, "lines"),  # Increase horizontal gap
    panel.spacing.y = unit(1, "lines")   # Use 1 (or whatever) for vertical gap
  )
}

# Generate individual plots
plot_CFR_fT_Plasma <- plot_CFR(df_CFR_fT_Plasma, "CFR (%T > MIC 85% for Plasma)")
plot_CFR_fT_CSF <- plot_CFR(df_CFR_fT_CSF, "CFR (%T > MIC 85% for CSF)")
plot_CFR_AUC_Plasma <- plot_CFR(df_CFR_AUC_Plasma, "CFR (AUC/MIC > 100 for Plasma)")
plot_CFR_AUC_CSF <- plot_CFR(df_CFR_AUC_CSF, "CFR (AUC/MIC > 100 for CSF)")

# Arrange all plots into one figure using ggarrange()
combined_CFR_plot <- ggarrange(
  plot_CFR_fT_Plasma, plot_CFR_fT_CSF, 
  plot_CFR_AUC_Plasma, plot_CFR_AUC_CSF,
  ncol = 2, nrow = 2,                        # Arrange in a 2x2 grid
  labels = c("A", "B", "C", "D"),            # Panel labels
  common.legend = TRUE, legend = "top"       # Common legend at the top
)

# Display final combined plot
print(combined_CFR_plot)

# Save as PNG
png("C:/Users/thomas.duflot/Desktop/LZD/R2/CFR_Combined_Plot.png", width = 16, height = 12, units = "in", res = 300)
print(combined_CFR_plot)
dev.off()




# List of packages
packages <- c("mrgsolve", "dplyr", "ggplot2", "ggpubr", "ggsci", 
              "flextable", "officer", "tidyr", "reshape2")

# Detect R version
r_version <- R.version
r_citation <- citation()

# Detect RStudio version (if available)
rstudio_version <- tryCatch(
  paste0("RStudio version ", rstudioapi::versionInfo()$version),
  error = function(e) "RStudio version not detected"
)

# Open a file to write BibTeX references
bib_file <- file("R_packages_citations.bib", "w")

# Write R citation
writeLines(toBibtex(r_citation), bib_file)

# Write RStudio citation manually (since it doesn't have a built-in citation)
writeLines("\n@Manual{RStudio,\n  title = {RStudio: Integrated Development Environment for R},\n  author = {RStudio Team},\n  year = {2024},\n  url = {https://posit.co/products/open-source/rstudio/},\n}\n", bib_file)

# Write package citations
for (pkg in packages) {
  cite <- toBibtex(citation(pkg))
  writeLines(cite, bib_file)
}

# Close the file
close(bib_file)

# Print message
cat("BibTeX file 'R_packages_citations.bib' successfully created in your working directory.\n")
cat("Detected R version:", r_version$version.string, "\n")
cat("Detected", rstudio_version, "\n")





























## ============================================
## DF model – weight scenarios (50–130 kg)
## ============================================

weights_vec <- c(50, 70, 90, 110, 130)
n_ind_per_wt <- 1000   # number of individuals per weight

## idata with one covariate WT per subject
DF_idata <- expand.grid(
  WT  = weights_vec,
  rep = 1:n_ind_per_wt
) %>%
  arrange(WT, rep) %>%
  mutate(ID = dplyr::row_number()) %>%
  select(ID, WT)

## Make sure Dosing factor has the right order
dosing_levels <- c("600q12h", "600q8h", "600q6h",
                   "1200q24hCI", "1800q24hCI", "2400q24hCI")

DF_wt_results <- vector("list", length(DF_events))
names(DF_wt_results) <- names(DF_events)

for (ev_name in names(DF_events)) {
  DF_out <- DF_mod %>%
    ev(DF_events[[ev_name]]) %>%
    mrgsim(idata = DF_idata, delta = 0.1, end = 96, obsonly = TRUE)
  
  DF_wt_results[[ev_name]] <- as.data.frame(DF_out) %>%
    left_join(DF_idata, by = "ID") %>%
    mutate(
      Dosing = factor(ev_name, levels = dosing_levels)
    )
}

## All DF simulations with weight as covariate
DF_wt_sim <- bind_rows(DF_wt_results) %>%
  mutate(
    WT = factor(WT, levels = weights_vec,
                labels = paste0(weights_vec, " kg"))
  )


## ============================================
## Steady-state Cmin & AUC (72–96 h)
## ============================================

DF_wt_ss <- DF_wt_sim %>%
  filter(time >= 72, time <= 96) %>%
  group_by(Dosing, WT, ID) %>%
  summarise(
    min_DVf      = min(DVf,    na.rm = TRUE),
    min_DVCSF    = min(DVCSF,  na.rm = TRUE),
    AUCP_72_96   = max(AUCP,   na.rm = TRUE) - min(AUCP,   na.rm = TRUE),
    AUCCSF_72_96 = max(AUCCSF, na.rm = TRUE) - min(AUCCSF, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    # avoid 0 on log scale
    min_DVf   = ifelse(min_DVf   == 0, 0.01, min_DVf),
    min_DVCSF = ifelse(min_DVCSF == 0, 0.01, min_DVCSF)
  )




## ============================================
## AUC plots – DF model by weight
## ============================================

custom_breaks_auc <- c(10, 30, 50, 100, 300, 500, 1000)
y_limits_auc      <- c(10, 1000)

# Plasma AUC
DF_AUC_Plasma_wt <- ggplot(DF_wt_ss,
                           aes(x = Dosing,
                               y = AUCP_72_96,
                               fill = WT)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "DF model – Plasma AUC according to dosing regimen and weight",
    x = "Dosing regimen",
    y = "Plasma AUC 72–96 h (mg·h/L)"
  ) +
  scale_fill_jco(name = "Weight") +
  scale_y_log10(breaks = custom_breaks_auc,
                limits = y_limits_auc,
                labels = scales::comma_format()) +
  my_theme

# CSF AUC
DF_AUC_CSF_wt <- ggplot(DF_wt_ss,
                        aes(x = Dosing,
                            y = AUCCSF_72_96,
                            fill = WT)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "DF model – CSF AUC according to dosing regimen and weight",
    x = "Dosing regimen",
    y = "CSF AUC 72–96 h (mg·h/L)"
  ) +
  scale_fill_jco(name = "Weight") +
  scale_y_log10(breaks = custom_breaks_auc,
                limits = y_limits_auc,
                labels = scales::comma_format()) +
  my_theme

DF_AUC_plot <- ggarrange(
  DF_AUC_Plasma_wt,
  DF_AUC_CSF_wt,
  ncol = 1, nrow = 2,
  labels = c("A", "B"),
  common.legend = TRUE,
  legend = "top"
)

# Adapt the path to your system
png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_AUC_Weight_Plot.png",
    width = 20, height = 12, units = "in", res = 900)
print(DF_AUC_plot)
dev.off()



## ============================================
## Cmin plots – DF model by weight
## ============================================

custom_breaks_cmin <- c(0.1, 0.3, 0.5, 1, 3, 5, 10, 30, 50)
y_limits_cmin      <- c(0.01, 50)

# Plasma Cmin
DF_Cmin_Plasma_wt <- ggplot(DF_wt_ss,
                            aes(x = Dosing,
                                y = min_DVf,
                                fill = WT)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "DF model – Plasma Cmin according to dosing regimen and weight",
    x = "Dosing regimen",
    y = "Plasma Cmin 72–96 h (mg/L)"
  ) +
  scale_fill_jco(name = "Weight") +
  scale_y_log10(breaks = custom_breaks_cmin,
                limits = y_limits_cmin,
                labels = scales::comma_format()) +
  my_theme

# CSF Cmin
DF_Cmin_CSF_wt <- ggplot(DF_wt_ss,
                         aes(x = Dosing,
                             y = min_DVCSF,
                             fill = WT)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "DF model – CSF Cmin according to dosing regimen and weight",
    x = "Dosing regimen",
    y = "CSF Cmin 72–96 h (mg/L)"
  ) +
  scale_fill_jco(name = "Weight") +
  scale_y_log10(breaks = custom_breaks_cmin,
                limits = y_limits_cmin,
                labels = scales::comma_format()) +
  my_theme

DF_Cmin_plot <- ggarrange(
  DF_Cmin_Plasma_wt,
  DF_Cmin_CSF_wt,
  ncol = 1, nrow = 2,
  labels = c("A", "B"),
  common.legend = TRUE,
  legend = "top"
)

png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_Cmin_Weight_Plot.png",
    width = 20, height = 12, units = "in", res = 900)
print(DF_Cmin_plot)
dev.off()




## ============================================
## PK profiles in plasma – DF model by weight
## ============================================

DF_profile_plasma <- DF_wt_sim %>%
  group_by(Dosing, WT, time) %>%
  summarise(
    median_DVf  = median(DVf, na.rm = TRUE),
    lower_IQR   = quantile(DVf, 0.25, na.rm = TRUE),
    upper_IQR   = quantile(DVf, 0.75, na.rm = TRUE),
    lower_5th   = quantile(DVf, 0.05, na.rm = TRUE),
    upper_95th  = quantile(DVf, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

DF_PK_Plasma <- DF_profile_plasma %>%
  ggplot(aes(x = time,
             y = median_DVf,
             colour = WT)) +
  geom_line(size = 1.2) +
  facet_wrap(~ Dosing, scales = "free_x") +
  scale_colour_jco(name = "Weight") +
  xlab("Time (hours)") +
  ylab("Linezolid in plasma (mg/L)") +
  ggtitle("DF model – LZD PK profile in plasma by weight") +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"),
        panel.spacing.y = unit(1, "lines"))

png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_PK_Plasma_Weight.png",
    width = 20, height = 10, units = "in", res = 900)
print(DF_PK_Plasma)
dev.off()



## ============================================
## PK profiles in CSF – DF model by weight
## ============================================

DF_profile_csf <- DF_wt_sim %>%
  group_by(Dosing, WT, time) %>%
  summarise(
    median_DVCSF = median(DVCSF, na.rm = TRUE),
    lower_IQR    = quantile(DVCSF, 0.25, na.rm = TRUE),
    upper_IQR    = quantile(DVCSF, 0.75, na.rm = TRUE),
    lower_5th    = quantile(DVCSF, 0.05, na.rm = TRUE),
    upper_95th   = quantile(DVCSF, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

DF_PK_CSF <- DF_profile_csf %>%
  ggplot(aes(x = time,
             y = median_DVCSF,
             colour = WT)) +
  geom_line(size = 1.2) +
  facet_wrap(~ Dosing, scales = "free_x") +
  scale_colour_jco(name = "Weight") +
  xlab("Time (hours)") +
  ylab("Linezolid in CSF (mg/L)") +
  ggtitle("DF model – LZD PK profile in CSF by weight") +
  my_theme +
  theme(panel.spacing.x = unit(2, "lines"),
        panel.spacing.y = unit(1, "lines"))

png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_PK_CSF_Weight.png",
    width = 20, height = 10, units = "in", res = 900)
print(DF_PK_CSF)
dev.off()






## ============================================
## PTA by weight – DF model
## ============================================

# Same MIC values as before
MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)

# Target AUC/MIC threshold (can change if needed)
target_AUC_MIC <- 100


## --------------------------------------------
## 6.1 fT>MIC PTA by weight (Plasma + CSF)
## --------------------------------------------

DF_wt_72_96 <- DF_wt_sim %>%
  filter(time >= 72, time <= 96)

PTA_fT_list <- list()

for (mic in MIC_values) {
  tmp <- DF_wt_72_96 %>%
    group_by(WT, Dosing, ID) %>%
    summarise(
      prop_above_MIC_DVf   = mean(DVf   >= mic, na.rm = TRUE),
      prop_above_MIC_DVCSF = mean(DVCSF >= mic, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    group_by(WT, Dosing) %>%
    summarise(
      PTA_fT_DVf   = mean(prop_above_MIC_DVf   >= 0.85) * 100,
      PTA_fT_DVCSF = mean(prop_above_MIC_DVCSF >= 0.85) * 100,
      .groups = "drop"
    ) %>%
    mutate(MIC = mic)
  
  PTA_fT_list[[as.character(mic)]] <- tmp
}

DF_PTA_fT_weight <- bind_rows(PTA_fT_list)

## --------------------------------------------
## 6.2 AUC/MIC>100 PTA by weight (Plasma + CSF)
## --------------------------------------------

PTA_AUC_list <- list()

for (mic in MIC_values) {
  tmp <- DF_wt_ss %>%
    group_by(WT, Dosing) %>%
    summarise(
      PTA_AUC_DVf   = mean((AUCP_72_96   / mic) >= target_AUC_MIC) * 100,
      PTA_AUC_DVCSF = mean((AUCCSF_72_96 / mic) >= target_AUC_MIC) * 100,
      .groups = "drop"
    ) %>%
    mutate(MIC = mic)
  
  PTA_AUC_list[[as.character(mic)]] <- tmp
}

DF_PTA_AUC_weight <- bind_rows(PTA_AUC_list)






DF_PTA_fT_plasma_plot <- DF_PTA_fT_weight %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_fT_DVf,
             group = WT,
             colour = WT)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all")+
  scale_colour_jco(name = "Weight") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab("PTA (%) – %T>MIC (Plasma)") +
  ggtitle("DF model – PTA %T>MIC in plasma by weight and dosing regimen") +
  my_theme

png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_PTA_fT_Plasma_Weight.png",
    width = 20, height = 10, units = "in", res = 900)
print(DF_PTA_fT_plasma_plot)
dev.off()







DF_PTA_fT_csf_plot <- DF_PTA_fT_weight %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_fT_DVCSF,
             group = WT,
             colour = WT)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all")+
  scale_colour_jco(name = "Weight") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab("PTA (%) – %T>MIC (CSF)") +
  ggtitle("DF model – PTA %T>MIC in CSF by weight and dosing regimen") +
  my_theme

png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_PTA_PercT_CSF_Weight.png",
    width = 20, height = 10, units = "in", res = 900)
print(DF_PTA_fT_csf_plot)
dev.off()





DF_PTA_AUC_plasma_plot <- DF_PTA_AUC_weight %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_AUC_DVf,
             group = WT,
             colour = WT)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all") +
  scale_colour_jco(name = "Weight") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab(paste0("PTA (%) – AUC/MIC ≥ ", target_AUC_MIC, " (Plasma)")) +
  ggtitle("DF model – PTA AUC/MIC in plasma by weight and dosing regimen") +
  my_theme

png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_PTA_AUC_Plasma_Weight.png",
    width = 20, height = 10, units = "in", res = 900)
print(DF_PTA_AUC_plasma_plot)
dev.off()





DF_PTA_AUC_csf_plot <- DF_PTA_AUC_weight %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_AUC_DVCSF,
             group = WT,
             colour = WT)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all")+
  scale_colour_jco(name = "Weight") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab(paste0("PTA (%) – AUC/MIC ≥ ", target_AUC_MIC, " (CSF)")) +
  ggtitle("DF model – PTA AUC/MIC in CSF by weight and dosing regimen") +
  my_theme

png("C:/Users/thomas.duflot/Desktop/LZD/R2/DF_PTA_AUC_CSF_Weight.png",
    width = 20, height = 10, units = "in", res = 900)
print(DF_PTA_AUC_csf_plot)
dev.off()



## ============================================
## Combine PTA metrics by weight into one table
## ============================================

# Join fT>MIC PTA and AUC/MIC PTA
DF_PTA_weight_table <- DF_PTA_fT_weight %>%
  left_join(
    DF_PTA_AUC_weight,
    by = c("WT", "Dosing", "MIC")
  ) %>%
  arrange(Dosing, WT, MIC) %>%
  mutate(
    PTA_fT_DVf   = round(PTA_fT_DVf,   1),
    PTA_fT_DVCSF = round(PTA_fT_DVCSF, 1),
    PTA_AUC_DVf  = round(PTA_AUC_DVf,  1),
    PTA_AUC_DVCSF= round(PTA_AUC_DVCSF,1)
  )

# Optional: rename for nicer column titles
DF_PTA_weight_table <- DF_PTA_weight_table %>%
  rename(
    `PTA %T>MIC Plasma (%)`            = PTA_fT_DVf,
    `PTA %T>MIC CSF (%)`               = PTA_fT_DVCSF,
    `PTA AUC/MIC≥100 Plasma (%)`       = PTA_AUC_DVf,
    `PTA AUC/MIC≥100 CSF (%)`          = PTA_AUC_DVCSF
  )

## ============================================
## Flextable + Word export
## ============================================

ft_DF_PTA_weight <- DF_PTA_weight_table %>%
  flextable() %>%
  set_header_labels(
    WT  = "Weight",
    Dosing = "Dosing regimen",
    MIC = "MIC (mg/L)",
    `PTA %T>MIC Plasma (%)`      = "Plasma",
    `PTA %T>MIC CSF (%)`         = "CSF",
    `PTA AUC/MIC≥100 Plasma (%)` = "Plasma",
    `PTA AUC/MIC≥100 CSF (%)`    = "CSF"
  ) %>%
  # Add a grouped header row
  add_header_row(
    values = c(
      "Weight", "Dosing regimen", "MIC (mg/L)",
      "PTA %T>MIC (≥85% of time 72–96 h)",
      paste0("PTA AUC/MIC ≥ ", target_AUC_MIC, " (72–96 h)")
    ),
    colwidths = c(1, 1, 1, 2, 2)
  ) %>%
  merge_h(part = "header") %>%
  merge_v(j = c("WT", "Dosing")) %>%  # merge identical WT & dosing downwards
  align(j = c("WT", "Dosing", "MIC"), align = "center", part = "all") %>%
  autofit() %>%
  fontsize(size = 9, part = "all")

# Export to Word
doc <- read_docx() %>%
  body_add_par("DF model – PTA by weight", style = "heading 1") %>%
  body_add_flextable(ft_DF_PTA_weight)

print(doc, target = "DF_PTA_Weight_Table.docx")



library(dplyr)
library(ggplot2)
library(ggh4x)
library(ggsci)

## ------------------------------------------------
## Li model – CrCl scenarios
## ------------------------------------------------

# Output folder (adapt if needed)
out_dir <- "C:/Users/thomas.duflot/Desktop/LZD/R2/"

# Creatinine clearance scenarios
CrCl_vec <- c(45, 90, 120, 150, 200,250)
n_ind_per_CrCl <- 1000

# idata: each subject has a CrCl and a (fixed) PCT
Li_idata <- expand.grid(
  CrCl = CrCl_vec,
  rep  = 1:n_ind_per_CrCl
) %>%
  arrange(CrCl, rep) %>%
  mutate(
    ID  = dplyr::row_number(),
    PCT = 0.14      # typical PCT from your model
  ) %>%
  select(ID, CrCl, PCT)

# Make sure dosing factor is ordered
dosing_levels <- c("600q12h", "600q8h", "600q6h",
                   "1200q24hCI", "1800q24hCI", "2400q24hCI")

Li_CrCl_results <- vector("list", length(Li_events))
names(Li_CrCl_results) <- names(Li_events)

for (ev_name in names(Li_events)) {
  Li_out <- Li_mod %>%
    ev(Li_events[[ev_name]]) %>%
    mrgsim(idata = Li_idata,
           delta = 0.1,
           end = 96,
           obsonly = TRUE)

  Li_CrCl_results[[ev_name]] <- as.data.frame(Li_out) %>%
    left_join(Li_idata, by = "ID") %>%
    mutate(
      Dosing = factor(ev_name, levels = dosing_levels)
    )
}

# All Li simulations with CrCl as covariate
Li_CrCl_sim <- bind_rows(Li_CrCl_results) %>%
  mutate(
    CrCl = factor(CrCl,
                  levels = CrCl_vec,
                  labels = paste0(CrCl_vec, " mL/min"))
  )





## ------------------------------------------------
## Steady-state (72–96 h) – Li + CrCl
## ------------------------------------------------

Li_CrCl_ss <- Li_CrCl_sim %>%
  filter(time >= 72, time <= 96) %>%
  group_by(Dosing, CrCl, ID) %>%
  summarise(
    min_DVf      = min(DVf,    na.rm = TRUE),
    min_DVCSF    = min(DVCSF,  na.rm = TRUE),
    AUCP_72_96   = max(AUCP,   na.rm = TRUE) - min(AUCP,   na.rm = TRUE),
    AUCCSF_72_96 = max(AUCCSF, na.rm = TRUE) - min(AUCCSF, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    # avoid zero on log scales if you later plot Cmin
    min_DVf   = ifelse(min_DVf   == 0, 0.01, min_DVf),
    min_DVCSF = ifelse(min_DVCSF == 0, 0.01, min_DVCSF)
  )



## ------------------------------------------------
## PTA by CrCl – Li model
## ------------------------------------------------

MIC_values <- c(0.25, 0.5, 1, 2, 4, 8, 16, 32)
target_AUC_MIC <- 100

## 3.1 fT>MIC PTA by CrCl (Plasma + CSF)

Li_CrCl_72_96 <- Li_CrCl_sim %>%
  filter(time >= 72, time <= 96)

PTA_fT_list_Li <- list()

for (mic in MIC_values) {
  tmp <- Li_CrCl_72_96 %>%
    group_by(CrCl, Dosing, ID) %>%
    summarise(
      prop_above_MIC_DVf   = mean(DVf   >= mic, na.rm = TRUE),
      prop_above_MIC_DVCSF = mean(DVCSF >= mic, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    group_by(CrCl, Dosing) %>%
    summarise(
      PTA_fT_DVf   = mean(prop_above_MIC_DVf   >= 0.85) * 100,
      PTA_fT_DVCSF = mean(prop_above_MIC_DVCSF >= 0.85) * 100,
      .groups = "drop"
    ) %>%
    mutate(MIC = mic)

  PTA_fT_list_Li[[as.character(mic)]] <- tmp
}

Li_PTA_fT_CrCl <- bind_rows(PTA_fT_list_Li)

## 3.2 AUC/MIC≥100 PTA by CrCl (Plasma + CSF)

PTA_AUC_list_Li <- list()

for (mic in MIC_values) {
  tmp <- Li_CrCl_ss %>%
    group_by(CrCl, Dosing) %>%
    summarise(
      PTA_AUC_DVf   = mean((AUCP_72_96   / mic) >= target_AUC_MIC) * 100,
      PTA_AUC_DVCSF = mean((AUCCSF_72_96 / mic) >= target_AUC_MIC) * 100,
      .groups = "drop"
    ) %>%
    mutate(MIC = mic)

  PTA_AUC_list_Li[[as.character(mic)]] <- tmp
}

Li_PTA_AUC_CrCl <- bind_rows(PTA_AUC_list_Li)




Li_PTA_fT_plasma_plot <- Li_PTA_fT_CrCl %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_fT_DVf,
             group = CrCl,
             colour = CrCl)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all") +
  scale_colour_jco(name = "CrCl") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab("PTA (%) – %T>MIC (Plasma)") +
  ggtitle("Li model – PTA %T>MIC in plasma by CrCl and dosing regimen") +
  my_theme

png(file.path(out_dir, "Li_PTA_PercT_Plasma_CrCl.png"),
    width = 20, height = 10, units = "in", res = 900)
print(Li_PTA_fT_plasma_plot)
dev.off()



Li_PTA_fT_csf_plot <- Li_PTA_fT_CrCl %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_fT_DVCSF,
             group = CrCl,
             colour = CrCl)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all") +
  scale_colour_jco(name = "CrCl") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab("PTA (%) – %T>MIC (CSF)") +
  ggtitle("Li model – PTA %T>MIC in CSF by CrCl and dosing regimen") +
  my_theme

png(file.path(out_dir, "Li_PTA_percT_CSF_CrCl.png"),
    width = 20, height = 10, units = "in", res = 900)
print(Li_PTA_fT_csf_plot)
dev.off()



Li_PTA_AUC_plasma_plot <- Li_PTA_AUC_CrCl %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_AUC_DVf,
             group = CrCl,
             colour = CrCl)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all") +
  scale_colour_jco(name = "CrCl") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab(paste0("PTA (%) – AUC/MIC ≥ ", target_AUC_MIC, " (Plasma)")) +
  ggtitle("Li model – PTA AUC/MIC in plasma by CrCl and dosing regimen") +
  my_theme

png(file.path(out_dir, "Li_PTA_AUC_Plasma_CrCl.png"),
    width = 20, height = 10, units = "in", res = 900)
print(Li_PTA_AUC_plasma_plot)
dev.off()




Li_PTA_AUC_csf_plot <- Li_PTA_AUC_CrCl %>%
  ggplot(aes(x = factor(MIC),
             y = PTA_AUC_DVCSF,
             group = CrCl,
             colour = CrCl)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  ggh4x::facet_wrap2(~ Dosing, axes = "all") +
  scale_colour_jco(name = "CrCl") +
  ylim(0, 100) +
  xlab("MIC (mg/L)") +
  ylab(paste0("PTA (%) – AUC/MIC ≥ ", target_AUC_MIC, " (CSF)")) +
  ggtitle("Li model – PTA AUC/MIC in CSF by CrCl and dosing regimen") +
  my_theme

png(file.path(out_dir, "Li_PTA_AUC_CSF_CrCl.png"),
    width = 20, height = 10, units = "in", res = 900)
print(Li_PTA_AUC_csf_plot)
dev.off()





## ------------------------------------------------
## Steady-state (72–96 h) – Li + CrCl
## ------------------------------------------------

Li_CrCl_ss <- Li_CrCl_sim %>%
  dplyr::filter(time >= 72, time <= 96) %>%
  dplyr::group_by(Dosing, CrCl, ID) %>%
  dplyr::summarise(
    min_DVf      = min(DVf,    na.rm = TRUE),
    min_DVCSF    = min(DVCSF,  na.rm = TRUE),
    AUCP_72_96   = max(AUCP,   na.rm = TRUE) - min(AUCP,   na.rm = TRUE),
    AUCCSF_72_96 = max(AUCCSF, na.rm = TRUE) - min(AUCCSF, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  dplyr::mutate(
    # Avoid 0 on log scale if you plot later
    min_DVf   = ifelse(min_DVf   == 0, 0.01, min_DVf),
    min_DVCSF = ifelse(min_DVCSF == 0, 0.01, min_DVCSF)
  )




## ------------------------------------------------
## AUC plots – Li model by CrCl
## ------------------------------------------------

custom_breaks_auc <- c(10, 30, 50, 100, 300, 500, 1000,2000)
y_limits_auc      <- c(10, 2000)

# Plasma AUC
Li_AUC_Plasma_CrCl <- ggplot(Li_CrCl_ss,
                             aes(x = Dosing,
                                 y = AUCP_72_96,
                                 fill = CrCl)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "Li model – Plasma AUC according to dosing regimen and CrCl",
    x = "Dosing regimen",
    y = "Plasma AUC 72–96 h (mg·h/L)"
  ) +
  scale_fill_jco(name = "CrCl") +
  scale_y_log10(breaks = custom_breaks_auc,
                limits = y_limits_auc,
                labels = scales::comma_format()) +
  my_theme

# CSF AUC
Li_AUC_CSF_CrCl <- ggplot(Li_CrCl_ss,
                          aes(x = Dosing,
                              y = AUCCSF_72_96,
                              fill = CrCl)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "Li model – CSF AUC according to dosing regimen and CrCl",
    x = "Dosing regimen",
    y = "CSF AUC 72–96 h (mg·h/L)"
  ) +
  scale_fill_jco(name = "CrCl") +
  scale_y_log10(breaks = custom_breaks_auc,
                limits = y_limits_auc,
                labels = scales::comma_format()) +
  my_theme

Li_AUC_plot <- ggpubr::ggarrange(
  Li_AUC_Plasma_CrCl,
  Li_AUC_CSF_CrCl,
  ncol = 1, nrow = 2,
  labels = c("A", "B"),
  common.legend = TRUE,
  legend = "top"
)

png(file.path(out_dir, "Li_AUC_CrCl_Plot.png"),
    width = 20, height = 12, units = "in", res = 900)
print(Li_AUC_plot)
dev.off()



## ------------------------------------------------
## Cmin plots – Li model by CrCl
## ------------------------------------------------

custom_breaks_cmin <- c(0.1, 0.3, 0.5, 1, 3, 5, 10, 30, 50,70)
y_limits_cmin      <- c(0.01, 70)

# Plasma Cmin
Li_Cmin_Plasma_CrCl <- ggplot(Li_CrCl_ss,
                              aes(x = Dosing,
                                  y = min_DVf,
                                  fill = CrCl)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "Li model – Plasma Cmin according to dosing regimen and CrCl",
    x = "Dosing regimen",
    y = "Plasma Cmin 72–96 h (mg/L)"
  ) +
  scale_fill_jco(name = "CrCl") +
  scale_y_log10(breaks = custom_breaks_cmin,
                limits = y_limits_cmin,
                labels = scales::comma_format()) +
  my_theme

# CSF Cmin
Li_Cmin_CSF_CrCl <- ggplot(Li_CrCl_ss,
                           aes(x = Dosing,
                               y = min_DVCSF,
                               fill = CrCl)) +
  geom_violin(position = position_dodge(width = 0.85),
              alpha = 0.3, color = "black", linewidth = 1.5) +
  geom_boxplot(width = 0.2,
               position = position_dodge(width = 0.85),
               alpha = 0.7,
               outlier.shape = NA,
               color = "black", linewidth = 1.2) +
  labs(
    title = "Li model – CSF Cmin according to dosing regimen and CrCl",
    x = "Dosing regimen",
    y = "CSF Cmin 72–96 h (mg/L)"
  ) +
  scale_fill_jco(name = "CrCl") +
  scale_y_log10(breaks = custom_breaks_cmin,
                limits = y_limits_cmin,
                labels = scales::comma_format()) +
  my_theme

Li_Cmin_plot <- ggpubr::ggarrange(
  Li_Cmin_Plasma_CrCl,
  Li_Cmin_CSF_CrCl,
  ncol = 1, nrow = 2,
  labels = c("A", "B"),
  common.legend = TRUE,
  legend = "top"
)

png(file.path(out_dir, "Li_Cmin_CrCl_Plot.png"),
    width = 20, height = 12, units = "in", res = 900)
print(Li_Cmin_plot)
dev.off()





## ------------------------------------------------
## PK profiles in plasma – Li model by CrCl
## ------------------------------------------------

Li_profile_plasma <- Li_CrCl_sim %>%
  dplyr::group_by(Dosing, CrCl, time) %>%
  dplyr::summarise(
    median_DVf = median(DVf, na.rm = TRUE),
    lower_IQR  = quantile(DVf, 0.25, na.rm = TRUE),
    upper_IQR  = quantile(DVf, 0.75, na.rm = TRUE),
    .groups = "drop"
  )

Li_PK_Plasma <- Li_profile_plasma %>%
  ggplot(aes(x = time,
             y = median_DVf,
             colour = CrCl)) +
  geom_line(linewidth = 1.2) +
  ggh4x::facet_wrap2(~ Dosing, scales = "free_x", axes = "all") +
  scale_colour_jco(name = "CrCl") +
  xlab("Time (hours)") +
  ylab("Free linezolid in plasma (mg/L)") +
  ggtitle("Li model – LZD PK profile in plasma by CrCl") +
  my_theme

png(file.path(out_dir, "Li_PK_Plasma_CrCl.png"),
    width = 20, height = 10, units = "in", res = 900)
print(Li_PK_Plasma)
dev.off()





## ------------------------------------------------
## PK profiles in CSF – Li model by CrCl
## ------------------------------------------------

Li_profile_csf <- Li_CrCl_sim %>%
  dplyr::group_by(Dosing, CrCl, time) %>%
  dplyr::summarise(
    median_DVCSF = median(DVCSF, na.rm = TRUE),
    lower_IQR    = quantile(DVCSF, 0.25, na.rm = TRUE),
    upper_IQR    = quantile(DVCSF, 0.75, na.rm = TRUE),
    .groups = "drop"
  )

Li_PK_CSF <- Li_profile_csf %>%
  ggplot(aes(x = time,
             y = median_DVCSF,
             colour = CrCl)) +
  geom_line(linewidth = 1.2) +
  ggh4x::facet_wrap2(~ Dosing, scales = "free_x", axes = "all") +
  scale_colour_jco(name = "CrCl") +
  xlab("Time (hours)") +
  ylab("Linezolid in CSF (mg/L)") +
  ggtitle("Li model – LZD PK profile in CSF by CrCl") +
  my_theme

png(file.path(out_dir, "Li_PK_CSF_CrCl.png"),
    width = 20, height = 10, units = "in", res = 900)
print(Li_PK_CSF)
dev.off()








tox_cmin_thresh <- 7
tox_auc_thresh  <- c(Luque = 300, DF = 300, Li = 300)  # mg·h/L (72–96 h fAUC)

## =========================================================
## Resimulate the 3 models (Luque, DF, Li) over 0–96 h
## and build steady-state 72–96 h metrics
## =========================================================

library(dplyr)
library(mrgsolve)

set.seed(1234)

## ---------- 6 dosing regimens (common to all models) ----------
events_6 <- list(
  `600q12h`     = ev(amt = 600,  rate = 1200, cmt = 1, ii = 12, addl = 20),
  `600q8h`      = ev(amt = 600,  rate = 1200, cmt = 1, ii =  8, addl = 20),
  `600q6h`      = ev(amt = 600,  rate = 1200, cmt = 1, ii =  6, addl = 20),
  `1200q24hCI`  = ev(amt = 4800, rate =   50, cmt = 1, ii =  0, addl =  0),
  `1800q24hCI`  = ev(amt = 7200, rate =   75, cmt = 1, ii =  0, addl =  0),
  `2400q24hCI`  = ev(amt = 9600, rate =  100, cmt = 1, ii =  0, addl =  0)
)
dosing_levels <- names(events_6)

## ---------- helper: simulate one model over all regimens ----------
sim_model <- function(mod, idata, model_name, end = 96, delta = 0.1) {
  out_list <- vector("list", length(events_6))
  names(out_list) <- names(events_6)
  for (ev_name in names(events_6)) {
    out <- mod %>%
      ev(events_6[[ev_name]]) %>%
      mrgsim(idata = idata, end = end, delta = delta, obsonly = TRUE)
    out_list[[ev_name]] <- as.data.frame(out) %>%
      left_join(idata, by = "ID", multiple = "first") %>%
      mutate(Dosing = factor(ev_name, levels = dosing_levels),
             Model  = model_name)
  }
  bind_rows(out_list)
}

## ---------- N per model ----------
n_ind <- 1000

## ---------- IDATA per model (reference covariates) ----------
## DF: reference WT = 70 (as per your $PARAM)
DF_idata <- tibble(ID = 1:n_ind, WT = 70)

## Luque: no covariate (if your Luque model has any, add columns here)
Luque_idata <- tibble(ID = 1:n_ind)

## Li: reference renal function CrCl = 90, typical PCT = 0.14
Li_idata <- tibble(ID = 1:n_ind, CrCl = 90, PCT = 0.14)

## ---------- Simulate ----------
## Ensure the model objects exist; edit the names if different on your side
stopifnot(exists("DF_mod"), exists("Li_mod"), exists("Luque_mod"))

DF_sim    <- sim_model(DF_mod,    DF_idata,    "DF")
Luque_sim <- sim_model(Luque_mod, Luque_idata, "Luque")
Li_sim    <- sim_model(Li_mod,    Li_idata,    "Li")

## =========================================================
## Steady-state (72–96 h) metrics: Cmin (plasma) + fAUC (plasma)
## =========================================================
## NOTE: assumes your models accumulate AUCP over time (as in your DF code)
## and capture free plasma conc as DVf.

mk_ss <- function(sim_df) {
  sim_df %>%
    filter(time >= 72, time <= 96) %>%
    group_by(Dosing, ID) %>%
    summarise(
      min_DVf    = min(DVf,  na.rm = TRUE),
      AUCP_72_96 = max(AUCP, na.rm = TRUE) - min(AUCP, na.rm = TRUE),
      .groups = "drop"
    )
}

DF_ss    <- mk_ss(DF_sim)    %>% dplyr::mutate(Model = "DF")
Luque_ss <- mk_ss(Luque_sim) %>% dplyr::mutate(Model = "Luque")
Li_ss    <- mk_ss(Li_sim)    %>% dplyr::mutate(Model = "Li")

SS_all <- dplyr::bind_rows(Luque_ss, DF_ss, Li_ss)


## Optional: check quick heads
lapply(list(Luque_sim=Luque_sim, DF_sim=DF_sim, Li_sim=Li_sim), head)
lapply(list(Luque_ss=Luque_ss, DF_ss=DF_ss, Li_ss=Li_ss), head)


# Map model-specific AUC thresholds to each row
SS_all <- SS_all %>%
  mutate(
    tox_auc_cut = case_when(
      Model == "Luque" ~ tox_auc_thresh["Luque"],
      Model == "DF"    ~ tox_auc_thresh["DF"],
      Model == "Li"    ~ tox_auc_thresh["Li"]
    )
  )

# Probability of toxicity per Dosing × Model
tox_summary <- SS_all %>%
  group_by(Model, Dosing) %>%
  summarise(
    # % with free Cmin > 7 mg/L (plasma)
    Tox_Cmin_pct = mean(min_DVf > tox_cmin_thresh, na.rm = TRUE) * 100,
    # % with fAUC 72–96 h > model-specific threshold (plasma)
    Tox_AUC_pct  = mean(AUCP_72_96 > tox_auc_cut, na.rm = TRUE) * 100,
    n = n(),
    .groups = "drop"
  )






# Ensure Dosing order is the usual one
tox_summary <- tox_summary %>%
  mutate(
    Dosing = factor(
      Dosing,
      levels = c("600q12h", "600q8h", "600q6h",
                 "1200q24hCI", "1800q24hCI", "2400q24hCI")
    ),
    Model = factor(Model, levels = c("Luque", "DF", "Li"))
  )

# Top panel: Cmin toxicity
p_tox_cmin <- ggplot(tox_summary,
                     aes(x = Dosing, y = Tox_Cmin_pct, fill = Dosing)) +
  geom_col(width = 0.75, color = "black") +
  geom_text(aes(label = sprintf("%.1f%%", Tox_Cmin_pct)),
            vjust = -0.4, size = 3.3) +
  ggh4x::facet_wrap2(~ Model, axes = "all") +
  scale_fill_jco(guide = "none") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 20)) +
  labs(
    title = "Probability of toxicity – Cmin (plasma) > 7 mg/L",
    x = "Dosing regimen",
    y = "Probability (%)"
  ) +
  theme_bw(base_size = 12)

# Bottom panel: AUC toxicity
p_tox_auc <- ggplot(tox_summary,
                    aes(x = Dosing, y = Tox_AUC_pct, fill = Dosing)) +
  geom_col(width = 0.75, color = "black") +
  geom_text(aes(label = sprintf("%.1f%%", Tox_AUC_pct)),
            vjust = -0.4, size = 3.3) +
  ggh4x::facet_wrap2(~ Model, axes = "all") +
  scale_fill_jco(guide = "none") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 20)) +
  labs(
    title = "Probability of toxicity – AUC (72–96 h, plasma)",
    subtitle = "Threshold:300 mg·h/L",
    x = "Dosing regimen",
    y = "Probability (%)"
  ) +
  theme_bw(base_size = 12)

# Arrange top & bottom into a single figure
tox_plot <- ggpubr::ggarrange(
  p_tox_cmin, p_tox_auc,
  ncol = 1, nrow = 2,
  labels = c("A", "B")
)

png(file.path(out_dir, "Toxicity_Probability_Models.png"),
    width = 20, height = 14, units = "in", res = 900)
print(tox_plot)
dev.off()




# Violin/box for Cmin with a red threshold line
p_cmin_raw <- SS_all %>%
  ggplot(aes(x = Dosing, y = min_DVf, fill = Dosing)) +
  geom_violin(alpha = 0.3, color = "black", linewidth = 1) +
  geom_boxplot(width = 0.2, alpha = 0.7, outlier.shape = NA) +
  geom_hline(yintercept = tox_cmin_thresh, linetype = 2, linewidth = 1) +
  ggh4x::facet_wrap2(~ Model, axes = "all") +
  scale_fill_jco(guide = "none") +
  scale_y_log10() +
  labs(title = "Cmin (72–96 h, plasma) with toxicity threshold",
       y = "Cmin (mg/L)", x = "Dosing regimen") +
  theme_bw(base_size = 12)

# Violin/box for AUC with model-specific red line per facet
p_auc_raw <- SS_all %>%
  mutate(th_line = case_when(
    Model == "Luque" ~ tox_auc_thresh["Luque"],
    Model == "DF"    ~ tox_auc_thresh["DF"],
    Model == "Li"    ~ tox_auc_thresh["Li"]
  )) %>%
  ggplot(aes(x = Dosing, y = AUCP_72_96, fill = Dosing)) +
  geom_violin(alpha = 0.3, color = "black", linewidth = 1) +
  geom_boxplot(width = 0.2, alpha = 0.7, outlier.shape = NA) +
  ggh4x::facet_wrap2(~ Model, axes = "all") +
  scale_fill_jco(guide = "none") +
  scale_y_continuous(trans = "log10") +
  labs(title = "AUC (72–96 h, plasma) with model-specific toxicity thresholds",
       y = "AUC 72–96 h (mg·h/L)", x = "Dosing regimen") +
  theme_bw(base_size = 12) +
  # Add threshold per facet
  geom_hline(data = distinct(SS_all, Model) %>%
               mutate(th_line = tox_auc_thresh[Model]),
             aes(yintercept = th_line),
             linetype = 2, linewidth = 1, inherit.aes = FALSE)

png(file.path(out_dir, "Toxicity_Distributions_Models.png"),
    width = 20, height = 14, units = "in", res = 900)
print(ggpubr::ggarrange(p_cmin_raw, p_auc_raw, ncol = 1, nrow = 2, labels = c("A","B")))
dev.off()
